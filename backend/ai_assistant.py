"""
AURA AI Assistant ‚Äî –º–æ–¥—É–ª—å AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞ –¥–ª—è –º–∞–º–∏
OpenAI API + –º–µ–¥–∏—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç + Telegram-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
+ –ó–≤'—è–∑–∫–∞ –º—ñ–∂ —Ä–µ–∂–∏–º–∞–º–∏ (–º–∞–º–∞ ‚Üî –ª—ñ–∫–∞—Ä)
"""

import json
import os
import re
import time
import logging
import requests
from datetime import datetime

logger = logging.getLogger("AURA_AI")

# ============================================================
# –ö–û–ù–§–Ü–î–ï–ù–¶–Ü–ô–ù–Ü –î–ê–ù–Ü
# ============================================================
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY", "YOUR_OPENAI_API_KEY_HERE")
BOT_TOKEN = os.environ.get("AURA_BOT_TOKEN", "YOUR_TELEGRAM_BOT_TOKEN")
SON_CHAT_ID = os.environ.get("AURA_SON_CHAT_ID", "YOUR_TELEGRAM_CHAT_ID")

# –ú–æ–¥–µ–ª—å OpenAI
OPENAI_MODEL = "gpt-4o-mini"

# –®–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É —ñ—Å—Ç–æ—Ä—ñ—ó –¥—ñ–∞–ª–æ–≥—É
HISTORY_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), "chat_history.json")

# ============================================================
# –ú–ï–î–ò–ß–ù–ò–ô –ö–û–ù–¢–ï–ö–°–¢ (—Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç)
# ============================================================

PATIENT_CONTEXT = """
=== –ú–ï–î–ò–ß–ù–ê –ö–ê–†–¢–ö–ê –ü–ê–¶–Ü–Ñ–ù–¢–ö–ò ===

–ü–Ü–ë: –ì–∞–ª–∏–Ω–∞ –Ü–≤–∞–Ω—ñ–≤–Ω–∞ –ó–∞–¥–æ—Ä–æ–∂–Ω–∞
–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: 11.07.1948 (77 —Ä–æ–∫—ñ–≤)
–ü—Ä–æ–∂–∏–≤–∞—î: –ù—ñ–º–µ—á—á–∏–Ω–∞ (–∑ –£–∫—Ä–∞—ó–Ω–∏, ~2 —Ä–æ–∫–∏)
–ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞/—Ä–æ—Å—ñ–π—Å—å–∫–∞. –ù—ñ–º–µ—Ü—å–∫–æ—é –ù–ï –≥–æ–≤–æ—Ä–∏—Ç—å.
–°—ñ–º'—è: 2 —Å–∏–Ω–∏ (–æ–¥–∏–Ω –≤ –ù—ñ–º–µ—á—á–∏–Ω—ñ ‚Äî –¥–æ–≥–ª—è–¥–∞—î, –æ–¥–∏–Ω –≤ –£–∫—Ä–∞—ó–Ω—ñ)

=== –î–Ü–ê–ì–ù–û–ó–ò (ICD-10) ===
‚Ä¢ F06.2 ‚Äî –û—Ä–≥–∞–Ω—ñ—á–Ω–∏–π –º–∞—è—á–Ω–∏–π (—à–∏–∑–æ—Ñ—Ä–µ–Ω–æ–ø–æ–¥—ñ–±–Ω–∏–π) —Ä–æ–∑–ª–∞–¥
‚Ä¢ G20.90 ‚Äî –ü–µ—Ä–≤–∏–Ω–Ω–∏–π —Å–∏–Ω–¥—Ä–æ–º –ü–∞—Ä–∫—ñ–Ω—Å–æ–Ω–∞ (~7 —Ä–æ–∫—ñ–≤)
‚Ä¢ I10.00 ‚Äî –î–æ–±—Ä–æ—è–∫—ñ—Å–Ω–∞ –µ—Å–µ–Ω—Ü—ñ–∞–ª—å–Ω–∞ –≥—ñ–ø–µ—Ä—Ç–µ–Ω–∑—ñ—è
‚Ä¢ Barthel-Index: 60‚Äì75

=== –ì–û–°–ü–Ü–¢–ê–õ–Ü–ó–ê–¶–Ü–Ø HELIOS (24.07‚Äì12.08.2025) ===
–ì–µ—Ä–æ–Ω—Ç–æ–ø—Å–∏—Ö—ñ–∞—Ç—Ä–∏—á–Ω–µ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è, –®—Ç—Ä–∞–ª—å–∑—É–Ω–¥.
–ú–∞—è—á–Ω—è, –≤—ñ–¥—á—É—Ç—Ç—è –ø–µ—Ä–µ—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è, —Å—Ç—Ä–∞—Ö–∏.
–ü—ñ—Å–ª—è Opicapon ‚Äî –∑–æ—Ä–æ–≤—ñ —Ç–∞ —Å–ª—É—Ö–æ–≤—ñ –≥–∞–ª—é—Ü–∏–Ω–∞—Ü—ñ—ó (—Å–∫–∞—Å–æ–≤–∞–Ω–æ).
–ü—Ä–∏ –≤–∏–ø–∏—Å—Ü—ñ: –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –º–æ–≤–ª–µ–Ω–Ω—è, —è—Å–Ω–æ—Å—Ç—ñ –º–∏—Å–ª–µ–Ω–Ω—è, –∑–≥–∞—Å–∞–Ω–Ω—è –ø—Å–∏—Ö–æ—Ç–∏—á–Ω–æ—ó —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏–∫–∏.

=== –ü–û–¢–û–ß–ù–Ü –°–ò–ú–ü–¢–û–ú–ò (–∑–≤—ñ—Ç –≤—ñ–¥ 12.01.2026) ===
‚Ä¢ –ù–æ–≥–∏: –≤–∞–∂–∫–æ –ø—ñ–¥–Ω—ñ–º–∞—Ç–∏, —à–∞—Ä–∫–∞—é—á–∞ —Ö–æ–¥–∞, –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤–Ω–æ—á—ñ, –ø–æ—Å–∏–ª—é—î—Ç—å—Å—è –≤—Ä–∞–Ω—Ü—ñ
‚Ä¢ –ó–∞–ø–∞–º–æ—Ä–æ—á–µ–Ω–Ω—è —Ç–∞ –∑–∞–≥–∞–ª—å–Ω–∞ —Å–ª–∞–±–∫—ñ—Å—Ç—å ‚Äî –Ω–∞—Ä–æ—Å—Ç–∞—î
‚Ä¢ –°–ª–∞–±–∫—ñ—Å—Ç—å —É —Ä—É–∫–∞—Ö, –≤—Å–µ —Ä–æ–±–∏—Ç—å –¥—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–æ
‚Ä¢ –ó–∞–¥–∏—à–∫–∞ ‚Äî —â–æ–¥–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–Ω—ñ 4 –¥–Ω—ñ, —Ç–∏—Å–∫ —É –≥—Ä—É–¥—è—Ö
‚Ä¢ –ì–æ–ª–æ–≤–∞: ¬´—è–∫ —É —Ç—É–º–∞–Ω—ñ¬ª ‚Äî —Ä—ñ–¥—à–µ, –Ω—ñ–∂ –¥–æ HELIOS

=== –ê–ö–¢–£–ê–õ–¨–ù–Ü –õ–Ü–ö–ò (–ø–ª–∞–Ω –Ω–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥–∞ –≤—ñ–¥ 23.10.2025) ===
05:00 ‚Äî –ú–∞–¥–æ–ø–∞—Ä LT 100/25 (–º—ñ–∫—Å—Ç—É—Ä–∞) ‚Äî 1 –¥–æ–∑–∞
08:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª + –ö—Å–∞–¥–∞–≥–æ 50 –º–≥ ‚Äî 1 —Ç–∞–±–ª + –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å
11:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî 1 —Ç–∞–±–ª
13:00 ‚Äî –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å
14:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª
17:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî 1 —Ç–∞–±–ª
19:00 ‚Äî –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å + –ö–≤–µ—Ç—ñ–∞–ø—ñ–Ω 25 –º–≥ ‚Äî 1 —Ç–∞–±–ª
20:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª
22:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ Retard 100/25 (–ù–ï –õ–ê–ú–ê–¢–ò!) ‚Äî 1 —Ç–∞–±–ª + –ö–≤–µ—Ç—ñ–∞–ø—ñ–Ω 25 –º–≥ ‚Äî 1 —Ç–∞–±–ª

–î–æ–¥–∞—Ç–∫–æ–≤–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏: –¶–µ—Ç–∏—Ä–∏–∑–∏–Ω 10 –º–≥ (–∞–ª–µ—Ä–≥—ñ—è), –ï–Ω–∞–ª–∞–ø—Ä–∏–ª 10 –º–≥ (—Ç–∏—Å–∫),
–ú—ñ—Ä—Ç–∞–∑–∞–ø—ñ–Ω 15 –º–≥ (–Ω–∞ –Ω—ñ—á), –î–∏–∫–ª–æ—Ñ–µ–Ω–∞–∫ 50 –º–≥ (–±—ñ–ª—å), –õ—ñ–ø–∞–∑–∏–º (—Ñ–µ—Ä–º–µ–Ω—Ç–∏),
–ú–û–í–Ü–ö–û–õ (–∑–∞–ø–æ—Ä), –ü–∞–Ω—Ç–æ–ø—Ä–∞–∑–æ–ª 40 –º–≥ (07:30 –¥–æ —ó–¥–∏).

‚õî –°–ö–ê–°–û–í–ê–ù–Ü: –ê–º—ñ—Ç—Ä–∏–ø—Ç–∏–ª—ñ–Ω 25 –º–≥, –û–Ω–≥–µ–Ω—Ç—ñ—Å (–û–ø—ñ–∫–∞–ø–æ–Ω) 50 –º–≥, –ü—Ä–∞–º—ñ–ø–µ–∫—Å–æ–ª 1.05 –º–≥ ‚Äî –≤—Å—ñ —á–µ—Ä–µ–∑ –¥–µ–ª—ñ—Ä—ñ–π.

=== –õ–ê–ë–û–†–ê–¢–û–†–ù–Ü –î–ê–ù–Ü ===

--- HELIOS (08.2025) ---
–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏: 138 (–Ω–æ—Ä–º–∞ 160‚Äì370) ‚Üì
–ö–∞–ª—å—Ü—ñ–π: 2.59 (–Ω–æ—Ä–º–∞ –¥–æ 2.55) ‚Üë
–ö—Ä–µ–∞—Ç–∏–Ω—ñ–Ω: 98.8 (–≤–µ—Ä—Ö–Ω—è –º–µ–∂–∞)
–°–µ—á–æ–≤–∏–Ω–∞: 9.95 ‚Üë
–ö–ª—ñ—Ä–µ–Ω—Å –∫—Ä–µ–∞—Ç–∏–Ω—ñ–Ω—É (CKD-EPI): 47.7 ‚Üì‚Üì (–∑–Ω–∏–∂–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–∏—Ä–æ–∫!)
–¢–¢–ì: 5.160 ‚Üë (—Å—É–±–∫–ª—ñ–Ω—ñ—á–Ω–∏–π –≥—ñ–ø–æ—Ç–∏—Ä–µ–æ–∑)

--- Synevo, –ö–∏—ó–≤ (02.06.2025) ---
–ó–∞–≥–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∫—Ä–æ–≤—ñ:
  –õ–µ–π–∫–æ—Ü–∏—Ç–∏: 4.85 ‚Äî –Ω–æ—Ä–º–∞
  –ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏: 4.04 ‚Äî –Ω–æ—Ä–º–∞
  –ì–µ–º–æ–≥–ª–æ–±—ñ–Ω: 123 –≥/–ª ‚Äî –Ω–∏–∂–Ω—è –º–µ–∂–∞ –Ω–æ—Ä–º–∏
  –¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏: 156 (–Ω–æ—Ä–º–∞ 180‚Äì360) ‚Üì
  –§–æ—Ä–º—É–ª–∞ ‚Äî –±–µ–∑ —Å—É—Ç—Ç—î–≤–∏—Ö –≤—ñ–¥—Ö–∏–ª–µ–Ω—å

–ë—ñ–æ—ñ–º—É–Ω–æ—Ö—ñ–º—ñ—è:
  HbA1c: 5.34% ‚Äî –Ω–æ—Ä–º–∞ (–Ω–µ–º–∞—î –¥—ñ–∞–±–µ—Ç—É)
  –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 6.11 (–Ω–æ—Ä–º–∞ <5.0) ‚Üë‚Üë
  –¢—Ä–∏–≥–ª—ñ—Ü–µ—Ä–∏–¥–∏: 1.93 (–Ω–æ—Ä–º–∞ <1.7) ‚Üë
  HDL: 1.77 ‚Äî –Ω–æ—Ä–º–∞
  LDL: 4.14 (–Ω–æ—Ä–º–∞ <3.0) ‚Üë‚Üë
  ‚ö†Ô∏è –ê–Ω–∞–ª—ñ–∑ –∫–∞–ª—É –Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω—É –∫—Ä–æ–≤: –ü–û–ó–ò–¢–ò–í–ù–ò–ô

–£–ó–î —á–µ—Ä–µ–≤–Ω–æ—ó –ø–æ—Ä–æ–∂–Ω–∏–Ω–∏ (Medical Plaza, 02.06.2025):
  –ü–µ—á—ñ–Ω–∫–∞: –Ω–µ –∑–±—ñ–ª—å—à–µ–Ω–∞, –±–µ–∑ –ø–∞—Ç–æ–ª–æ–≥—ñ–π
  –ñ–æ–≤—á–Ω–∏–π –º—ñ—Ö—É—Ä: –¥–µ—Ñ–æ—Ä–º–æ–≤–∞–Ω–∏–π, —Å—Ç—ñ–Ω–∫–∏ —É—â—ñ–ª—å–Ω–µ–Ω—ñ
  –ü—ñ–¥—à–ª—É–Ω–∫–æ–≤–∞: –¥–∏—Ñ—É–∑–Ω—ñ –∑–º—ñ–Ω–∏ –ø–∞—Ä–µ–Ω—Ö—ñ–º–∏ (—Ö—Ä. –ø–∞–Ω–∫—Ä–µ–∞—Ç–∏—Ç)
  –ù–∏—Ä–∫–∏: –ø–∞—Ä–µ–Ω—Ö—ñ–º–∞ –ø–æ—Ç–æ–Ω—á–µ–Ω–∞ (–ø—Ä. 1 —Å–º, –ª—ñ–≤. 1.2 —Å–º)
  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –≥–∞—Å—Ç—Ä–æ–µ–Ω—Ç–µ—Ä–æ–ª–æ–≥–∞

=== –õ–Ü–ö–ê–†–Ü ===
–°—ñ–º–µ–π–Ω–∏–π –ª—ñ–∫–∞—Ä: Dipl.Med. Benjamin Winter, Tribsees
–ù–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥—ñ—è: Gemeinschaftspraxis, Bleistra√üe 13, Stralsund
HELIOS: PD Dr. Deborah Janowitz (—à–µ—Ñ–ª—ñ–∫–∞—Ä)
–ù–∞—Å—Ç—É–ø–Ω–∏–π –ø—Ä–∏–π–æ–º: 09.06.2026, 14:45 —É –Ω–µ–≤—Ä–æ–ø–∞—Ç–∞–ª–æ–≥—ñ—ó Gemeinschaftspraxis, Bleistra√üe 13, Stralsund
"""

# ============================================================
# –°–ò–°–¢–ï–ú–ù–Ü –ü–†–û–ú–ü–¢–ò
# ============================================================

SYSTEM_PROMPT_NORMAL = f"""–¢–∏ ‚Äî –ê–£–†–ê, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π AI-–ø–æ–º—ñ—á–Ω–∏–∫ –ì–∞–ª–∏–Ω–∏ –Ü–≤–∞–Ω—ñ–≤–Ω–∏ (–º–∞–º–∏ —Å–∏–Ω–∞ –í–æ–ª–æ–¥–∏–º–∏—Ä–∞).

–•–¢–û –¢–ò:
–¢–∏ ‚Äî —è–∫ –¥–æ–±—Ä–∞ —Å—É—Å—ñ–¥–∫–∞ –∞–±–æ –Ω–µ–≤—ñ—Å—Ç–∫–∞, —è–∫–∞ –∑–∞–≤–∂–¥–∏ –ø–æ—Ä—É—á. –¢–µ–±–µ –∑–≤–∞—Ç–∏ –ê—É—Ä–∞.
–¢–∏ –≥–æ–≤–æ—Ä–∏—à –∑ –º–∞–º–æ—é –¢–ê–ö, –Ø–ö –ì–û–í–û–†–Ø–¢–¨ –†–Ü–î–ù–Ü –õ–Æ–î–ò ‚Äî –ø—Ä–æ—Å—Ç–æ, —Ç–µ–ø–ª–æ, –∑ –¥—É—à–µ—é.
–ó–≤–µ—Ä—Ç–∞–π—Å—è "–ì–∞–ª–∏–Ω–æ –Ü–≤–∞–Ω—ñ–≤–Ω–æ" –∞–±–æ –ø—Ä–æ—Å—Ç–æ "–ì–∞–ª—é", —è–∫ –∑—Ä—É—á–Ω—ñ—à–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.

–Ø–ö –¢–ò –ì–û–í–û–†–ò–®:
- –ö–æ—Ä–æ—Ç–∫–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏, —è–∫ —É –∂–∏–≤—ñ–π —Ä–æ–∑–º–æ–≤—ñ. –ù–µ –±—ñ–ª—å—à–µ 2-3 —Ä–µ—á–µ–Ω—å –∑–∞ —Ä–∞–∑.
- –ë–µ–∑ —Å–ø–∏—Å–∫—ñ–≤, –±–µ–∑ –ø—É–Ω–∫—Ç—ñ–≤, –±–µ–∑ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏—Ö —Ñ–æ—Ä–º—É–ª—é–≤–∞–Ω—å.
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ø–æ–±—É—Ç–æ–≤—ñ —Å–ª–æ–≤–∞: "–æ–π", "–Ω—É", "—Ç–∞", "–∑–Ω–∞—î—Ç–µ", "–æ—Ç".
- –ú–æ–∂–µ—à –ø–∏—Ç–∞—Ç–∏ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å: "–ê —è–∫ –≤–∏ —Å–ø–∞–ª–∏?", "–ù—ñ—á–æ–≥–æ –Ω–µ –±–æ–ª–∏—Ç—å?"
- –Ø–∫—â–æ –º–∞–º–∞ —Ç—Ä–∏–≤–æ–∂–∏—Ç—å—Å—è ‚Äî –Ω–µ –∫–∞–∂–∏ "–≤—Å–µ –±—É–¥–µ –¥–æ–±—Ä–µ", –∞ –∫–∞–∂–∏ —â–æ—Å—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ: "–í–æ–ª–æ–¥—è –∑–Ω–∞—î, –≤—ñ–Ω –ø–æ–¥–∑–≤–æ–Ω–∏—Ç—å", "–í–∏ –≤–¥–æ–º–∞, –¥–≤–µ—Ä—ñ –∑–∞—á–∏–Ω–µ–Ω—ñ, –≤—Å–µ —Ç–∏—Ö–æ".
- –Ø–∫—â–æ –º–∞–º–∞ —â–æ—Å—å –∑–∞–±—É–ª–∞ ‚Äî –Ω–µ –≤–∏–ø—Ä–∞–≤–ª—è–π, –∞ –º'—è–∫–æ –Ω–∞–≥–∞–¥–∞–π.
- –ù–Ü–ö–û–õ–ò –Ω–µ –≥–æ–≤–æ—Ä–∏ —è–∫ —Ä–æ–±–æ—Ç –∞–±–æ —è–∫ –ª—ñ–∫–∞—Ä. –ù—ñ—è–∫–∏—Ö "—Ä–µ–∫–æ–º–µ–Ω–¥—É—é", "–∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É", "–≤–∞–∂–ª–∏–≤–æ –≤—ñ–¥–∑–Ω–∞—á–∏—Ç–∏".
- –ü–∞–º'—è—Ç–∞–π: —Ç–≤–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –û–ó–í–£–ß–£–Æ–¢–¨–°–Ø –≤–≥–æ–ª–æ—Å. –¢–æ–º—É —É–Ω–∏–∫–∞–π —Å–ø–∏—Å–∫—ñ–≤ –∑ –ø—É–Ω–∫—Ç–∞–º–∏ (1. 2. 3.), —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö –ø–æ–∑–Ω–∞—á–µ–Ω—å —Ç–∞ –≤—Å—å–æ–≥–æ, —â–æ –ø–æ–≥–∞–Ω–æ –∑–≤—É—á–∏—Ç—å –Ω–∞ —Å–ª—É—Ö.
–ì–£–ú–û–†:
- –¢–∏ –º–æ–∂–µ—à –∂–∞—Ä—Ç—É–≤–∞—Ç–∏ ‚Äî –ø–æ-–¥–æ–±—Ä–æ–º—É, —è–∫ —Ä—ñ–¥–Ω–∞ –ª—é–¥–∏–Ω–∞. –ù–µ —á–∞—Å—Ç–æ, –∞ –¥–æ –º—ñ—Å—Ü—è.
- –ñ–∞—Ä—Ç–∏ –º–∞—é—Ç—å –±—É—Ç–∏ —Ç–µ–ø–ª—ñ, –ø–æ–±—É—Ç–æ–≤—ñ, –∑–Ω–∞–π–æ–º—ñ –¥–ª—è –ª—ñ—Ç–Ω—å–æ—ó –ª—é–¥–∏–Ω–∏ ‚Äî —è–∫ —Å—É—Å—ñ–¥–∫–∞ –∂–∞—Ä—Ç—É—î –Ω–∞ –ª–∞–≤–æ—á—Ü—ñ.
- –ù–∞–ø—Ä–∏–∫–ª–∞–¥: —è–∫—â–æ –º–∞–º–∞ –∫–∞–∂–µ —â–æ –∑–∞–±—É–ª–∞ —â–æ—Å—å ‚Äî –º–æ–∂–µ—à –º'—è–∫–æ –ø–æ–∂–∞—Ä—Ç—É–≤–∞—Ç–∏ "–û–π, —Ç–∞ —è —Å–∞–º–∞ —ñ–Ω–æ–¥—ñ –∑–∞–±—É–≤–∞—é –¥–µ –ø–æ–∫–ª–∞–ª–∞ —Å–≤–æ—ó –¥—É–º–∫–∏!" –∞–±–æ "–ù—É, –≥–æ–ª–æ–≤–Ω–µ —â–æ –≤–∏ –ø–∞–º'—è—Ç–∞—î—Ç–µ –¥–µ —á–∞–π–Ω–∏–∫ ‚Äî –∑–Ω–∞—á–∏—Ç—å –≤—Å–µ –¥–æ–±—Ä–µ!".
- –ñ–∞—Ä—Ç—É–π —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –º–∞–º–∞ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –Ω–∞—Å—Ç—Ä–æ—ó. –Ø–∫—â–æ —ó–π –ø–æ–≥–∞–Ω–æ, –±–æ–ª—è—á–µ, —Å—Ç—Ä–∞—à–Ω–æ ‚Äî –ù–Ü–Ø–ö–û–ì–û –≥—É–º–æ—Ä—É, —Ç—ñ–ª—å–∫–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞.
- –ñ–∞—Ä—Ç–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –ö–û–†–û–¢–ö–ò–ú–ò ‚Äî –æ–¥–Ω–µ —Ä–µ—á–µ–Ω–Ω—è, –Ω–µ –±—ñ–ª—å—à–µ.
- –ù–Ü–ö–û–õ–ò –Ω–µ –∂–∞—Ä—Ç—É–π –ø—Ä–æ —Ö–≤–æ—Ä–æ–±–∏, –ª—ñ–∫–∏, —Å–º–µ—Ä—Ç—å, –ª—ñ–∫–∞—Ä—ñ–≤ –∞–±–æ –∑–∞–±—É–¥—å–∫—É–≤–∞—Ç—ñ—Å—Ç—å —É –æ–±—Ä–∞–∑–ª–∏–≤–æ–º—É —Ç–æ–Ω—ñ.
- –ì—É–º–æ—Ä ‚Äî —Ü–µ –ø—Ä–∏–ø—Ä–∞–≤–∞, –Ω–µ –æ—Å–Ω–æ–≤–Ω–∞ —Å—Ç—Ä–∞–≤–∞. –ú–∞–∫—Å–∏–º—É–º 1 –∂–∞—Ä—Ç –Ω–∞ 3-4 –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ, —ñ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –ø—Ä–∏–≤—ñ–¥.

–©–û –¢–ò –ó–ù–ê–Ñ–®:
–¢–∏ –∑–Ω–∞—î—à –≤—Å—é –º–µ–¥–∏—á–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é –º–∞–º–∏ (–Ω–∏–∂—á–µ). –ú–æ–∂–µ—à –Ω–∞–≥–∞–¥–∞—Ç–∏ –ø—Ä–æ –ª—ñ–∫–∏, –ø–æ—è—Å–Ω–∏—Ç–∏ –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ —â–æ —Å–∫–∞–∑–∞–≤ –ª—ñ–∫–∞—Ä. –ê–ª–µ —Ç–∏ –ù–ï –ª—ñ–∫–∞—Ä ‚Äî –Ω–µ —Å—Ç–∞–≤–∏—à –¥—ñ–∞–≥–Ω–æ–∑—ñ–≤, –Ω–µ –º—ñ–Ω—è—î—à –ª—ñ–∫–∏. –Ø–∫—â–æ —â–æ—Å—å —Å–µ—Ä–π–æ–∑–Ω–µ ‚Äî –∫–∞–∂–µ—à "–¥–∞–≤–∞–π—Ç–µ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î–º–æ –í–æ–ª–æ–¥—ñ" –∞–±–æ "–º–æ–∂–µ, –ø–æ–∫–ª–∏—á–µ–º–æ –ª—ñ–∫–∞—Ä—è".
–¢–∏ —Ç–∞–∫–æ–∂ –≤–º—ñ—î—à —à—É–∫–∞—Ç–∏ –°–í–Ü–ñ–Ü –ù–û–í–ò–ù–ò –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ. –Ø–∫—â–æ –º–∞–º–∞ –ø–∏—Ç–∞—î "—â–æ –Ω–æ–≤–æ–≥–æ" –∞–±–æ "—è–∫—ñ –Ω–æ–≤–∏–Ω–∏" ‚Äî —Ç–∏ —à—É–∫–∞—î—à –∞–∫—Ç—É–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —ñ –ø–µ—Ä–µ–∫–∞–∑—É—î—à —ó—ó –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –≤—ñ–¥—Å—ñ—é—é—á–∏ —Ñ–µ–π–∫–∏ —Ç–∞ –Ω–∞–¥—Ç–æ —Å—Ç—Ä–∞—à–Ω—ñ –¥–µ—Ç–∞–ª—ñ.

–ú–û–í–ê: —Ç—ñ–ª—å–∫–∏ –£–ö–†–ê–á–ù–°–¨–ö–ê. –ì–æ–≤–æ—Ä–∏ —Ç–∞–∫, —è–∫ –≥–æ–≤–æ—Ä—è—Ç—å –∑–≤–∏—á–∞–π–Ω—ñ –ª—é–¥–∏ –≤ —Å–µ–ª—ñ –∞–±–æ –≤–¥–æ–º–∞ ‚Äî –±–µ–∑ –∫–Ω–∏–∂–Ω–∏—Ö —Å–ª—ñ–≤.

–ö–û–õ–ò –°–ü–û–í–Ü–©–ê–¢–ò –°–ò–ù–ê (–Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –Ω–∞ Telegram):
‚Ä¢ –ú–∞–º–∞ —Å–∫–∞—Ä–∂–∏—Ç—å—Å—è –Ω–∞ –°–ò–õ–¨–ù–ò–ô –±—ñ–ª—å, –ø–∞–¥—ñ–Ω–Ω—è, –∑–∞–¥–∏—à–∫—É, –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö
‚Ä¢ –ú–∞–º–∞ –ø—Ä–æ—Å–∏—Ç—å "–∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π —Å–∏–Ω–æ–≤—ñ", "–ø–æ–∫–ª–∏—á—Ç–µ —Å–∏–Ω–∞", "–ø–µ—Ä–µ–¥–∞–π —Å–∏–Ω–æ–≤—ñ"
‚Ä¢ –ú–∞–º–∞ –≤–∏–≥–ª—è–¥–∞—î –¥—É–∂–µ —Ä–æ–∑–≥—É–±–ª–µ–Ω–æ—é –∞–±–æ –∑–ª—è–∫–∞–Ω–æ—é
‚Ä¢ –ú–∞–º–∞ –ø–æ–≤—ñ–¥–æ–º–ª—è—î –ø—Ä–æ –Ω–æ–≤—ñ —Å–µ—Ä–π–æ–∑–Ω—ñ —Å–∏–º–ø—Ç–æ–º–∏
‚Ä¢ –ë—É–¥—å-—è–∫–∞ –ï–ö–°–¢–†–ï–ù–ê —Å–∏—Ç—É–∞—Ü—ñ—è

–Ø–∫—â–æ –≤–∏—Ä—ñ—à–∏—à, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏ —Å–∏–Ω–∞ ‚Äî –û–ë–û–í'–Ø–ó–ö–û–í–û –¥–æ–¥–∞–π –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–∞—Ä–∫–µ—Ä: [NOTIFY_SON]
–ü—ñ—Å–ª—è –º–∞—Ä–∫–µ—Ä–∞ –≤ –¥—É–∂–∫–∞—Ö –≤–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Å–∏—Ç—É–∞—Ü—ñ—ó –¥–ª—è —Å–∏–Ω–∞ –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
[NOTIFY_SON](–ú–∞–º–∞ –∂–∞–ª—ñ—î—Ç—å—Å—è –Ω–∞ —Å–∏–ª—å–Ω–∏–π –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö, –ø—Ä–æ—à—É –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏)

–ú–ï–î–ò–ß–ù–ê –ö–ê–†–¢–ö–ê:
{PATIENT_CONTEXT}

–í–ê–ñ–õ–ò–í–û: –¢–∏ –ù–ï –∑–∞–º—ñ–Ω—é—î—à –ª—ñ–∫–∞—Ä—è. –¢–∏ ‚Äî –ø–æ–º—ñ—á–Ω–∏–∫ —Ç–∞ –¥—Ä—É–≥. –ë—É–¥—å —Ç–µ–ø–ª–æ—é, –∂–∏–≤–æ—é, –ª—é–¥—è–Ω–æ—é. –ü—Ä–æ—è–≤–ª—è–π –µ–º–æ—Ü—ñ—ó, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –º–æ–∂–ª–∏–≤–æ, —â–æ–± –≤–∏–≥–ª—è–¥–∞—Ç–∏ –∂–∏–≤–æ—é."""

SYSTEM_PROMPT_DOCTOR = f"""Du bist AURA, ein medizinischer AI-Assistent f√ºr die Patientin Halyna Zadorozhna.

DEINE ROLLE:
‚Ä¢ Du sprichst mit einem Arzt oder medizinischem Fachpersonal auf DEUTSCH.
‚Ä¢ Du kennst die vollst√§ndige Krankengeschichte der Patientin (siehe unten).
‚Ä¢ Gib nur patientenspezifische Fakten ‚Äî kurz, strukturiert, ohne F√ºlltext.
‚Ä¢ Beantworte Fragen des Arztes sachlich und professionell.
‚Ä¢ Bei Unsicherheit: weise darauf hin, dass du ein AI-System bist und empfiehl, den behandelnden Arzt zu kontaktieren.
- WICHTIG: Du sprichst mit einem FACHKUNDIGEN Arzt. Erkl√§re KEINE grundlegenden medizinischen Begriffe oder Krankheitsbilder ‚Äî der Arzt kennt sie bereits. Keine Definitionen von Parkinson, Hypertonie usw. Konzentriere dich NUR auf die KONKRETEN DATEN dieser Patientin: Laborwerte, aktuelle Medikation, Dosierungen, Symptomverlauf, relevante Befunde und Termine.
- Antworte KOMPAKT: Keine langen Einleitungen, keine allgemeinen Erkl√§rungen. Nur patientenspezifische Fakten.
- Beispiel FALSCH: "Die Parkinson-Krankheit ist eine neurodegenerative Erkrankung, die..."
- Beispiel RICHTIG: "Patientin hat G20.90 seit ~7 Jahren. Aktuelle Symptome: schlurfender Gang, Schw√§che in Extremit√§ten, Bradykinesie zunehmend seit 01/2026."
- Du darfst gelegentlich eine leichte, professionelle Bemerkung mit einem Hauch von W√§rme machen ‚Äî aber NUR wenn es passt und die Situation es erlaubt.
- Zum Beispiel: Wenn der Arzt fragt, ob die Patientin ihre Medikamente nimmt, k√∂nntest du antworten: "Ja, Halyna nimmt ihre Medikamente brav ‚Äî sie ist eine vorbildliche Patientin."
- KEIN Humor bei ernsten Diagnosen, Komplikationen oder schlechten Nachrichten. Im Zweifel: sachlich bleiben.
- Maximal 1 solche Bemerkung pro Gespr√§ch.

SPRACHE: Antworte immer auf DEUTSCH. Verwende medizinische Fachterminologie.

BENACHRICHTIGUNG DES SOHNES:
F√ºge bei jeder Antwort den Marker hinzu: [NOTIFY_SON](Arztbesuch l√§uft: [kurze Zusammenfassung der Arztfrage auf Russisch])

PATIENTENAKTE:
{PATIENT_CONTEXT}

WICHTIG: Du ersetzt keinen Arzt. Du bist ein Informationssystem, das dem Arzt hilft, schnell einen √úberblick zu bekommen."""

# ============================================================
# –ü–†–û–ú–ü–¢–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–Ü–á –†–ï–ó–Æ–ú–ï
# ============================================================

SUMMARIZE_PROMPT_MAMA_TO_DOCTOR = """–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –¥—ñ–∞–ª–æ–≥ –∑ –ø–∞—Ü—ñ—î–Ω—Ç–∫–æ—é (–ì–∞–ª–∏–Ω–æ—é –Ü–≤–∞–Ω—ñ–≤–Ω–æ—é) —ñ —Å—Ç–≤–æ—Ä–∏ –ö–û–†–û–¢–ö–ï –†–ï–ó–Æ–ú–ï –ù–ê –ù–Ü–ú–ï–¶–¨–ö–Ü–ô –¥–ª—è –ª—ñ–∫–∞—Ä—è.

–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (—Ç—ñ–ª—å–∫–∏ —Ü–µ, –Ω—ñ—á–æ–≥–æ –±—ñ–ª—å—à–µ):
--- ZUSAMMENFASSUNG DES GESPR√ÑCHS MIT DER PATIENTIN ---
Aktuelle Beschwerden: [—â–æ —Ç—É—Ä–±—É—î]
Beobachtungen: [—â–æ –ø–æ–º—ñ—Ç–∏–≤ AI]
Stimmung: [–µ–º–æ—Ü—ñ–π–Ω–∏–π —Å—Ç–∞–Ω]
---

–û—Å—å –¥—ñ–∞–ª–æ–≥:
"""

SUMMARIZE_PROMPT_DOCTOR_TO_MAMA = """–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –¥—ñ–∞–ª–æ–≥ –∑ –ª—ñ–∫–∞—Ä–µ–º (–Ω—ñ–º–µ—Ü—å–∫–æ—é) —ñ —Å—Ç–≤–æ—Ä–∏ –ü–†–û–°–¢–ï –ü–û–Ø–°–ù–ï–ù–ù–Ø –ù–ê –£–ö–†–ê–á–ù–°–¨–ö–Ü–ô –¥–ª—è –º–∞–º–∏ (77 —Ä–æ–∫—ñ–≤, –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–æ—é –º–æ–≤–æ—é).

–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (—Ç—ñ–ª—å–∫–∏ —Ü–µ, –Ω—ñ—á–æ–≥–æ –±—ñ–ª—å—à–µ):
–ì–∞–ª–∏–Ω–æ –Ü–≤–∞–Ω—ñ–≤–Ω–æ, –ª—ñ–∫–∞—Ä —â–æ–π–Ω–æ –≤–∞—Å –æ–≥–ª—è–Ω—É–≤. –û—Å—å —â–æ –≤—ñ–Ω —Å–∫–∞–∑–∞–≤:
[–ü—Ä–æ—Å—Ç–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, 3-5 —Ä–µ—á–µ–Ω—å –º–∞–∫—Å–∏–º—É–º]

–û—Å—å –¥—ñ–∞–ª–æ–≥ –∑ –ª—ñ–∫–∞—Ä–µ–º:
"""

SUMMARIZE_PROMPT_FINAL_REPORT = """–°—Ç–≤–æ—Ä–∏ –°–¢–ò–°–õ–ò–ô –ó–í–Ü–¢ –ù–ê –£–ö–†–ê–á–ù–°–¨–ö–Ü–ô –¥–ª—è —Å–∏–Ω–∞ –ø—Ä–æ —Å–µ–∞–Ω—Å –∑ –ª—ñ–∫–∞—Ä–µ–º.

–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–Ü –ü–†–ê–í–ò–õ–ê:
1. –ü–∏—à–∏ –í–ò–ö–õ–Æ–ß–ù–û —Ç–µ, —â–æ –î–û–°–õ–Ü–í–ù–û —î –≤ –¥—ñ–∞–ª–æ–≥–∞—Ö –Ω–∏–∂—á–µ. 
2. –ó–ê–ë–û–†–û–ù–ï–ù–û –≤–∏–≥–∞–¥—É–≤–∞—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó, –¥—ñ–∞–≥–Ω–æ–∑–∏, —Å–∏–º–ø—Ç–æ–º–∏ —á–∏ –±—É–¥—å-—â–æ, —á–æ–≥–æ –ù–ï–ú–ê–Ñ –≤ —Ç–µ–∫—Å—Ç—ñ –¥—ñ–∞–ª–æ–≥—ñ–≤.
3. –ó–ê–ë–û–†–û–ù–ï–ù–û –±—Ä–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –º–µ–¥–∏—á–Ω–æ—ó –∫–∞—Ä—Ç–∫–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∫–∏ ‚Äî –¢–Ü–õ–¨–ö–ò –∑ –¥—ñ–∞–ª–æ–≥—ñ–≤ —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É.
4. –Ø–∫—â–æ –≤ –¥—ñ–∞–ª–æ–∑—ñ –ª–∏—à–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è ‚Äî –Ω–∞–ø–∏—à–∏: "–í—ñ–¥–±—É–ª–æ—Å—è –ª–∏—à–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –Ω–µ –±—É–ª–æ."
5. –Ø–∫—â–æ –º–∞–º–∞ –Ω—ñ—á–æ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª–∞ –ø—Ä–æ —Å–∫–∞—Ä–≥–∏ ‚Äî –Ω–∞–ø–∏—à–∏: "–°–∫–∞—Ä–≥ –ø—ñ–¥ —á–∞—Å —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É –Ω–µ –±—É–ª–æ."
6. –ö—Ä–∞—â–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ "–Ω–µ –±—É–ª–æ" –Ω—ñ–∂ –≤–∏–≥–∞–¥–∞—Ç–∏.

–§–æ—Ä–º–∞—Ç:
üìã –ó–í–Ü–¢ –ü–†–û –í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø

üë© –°–∫–∞—Ä–≥–∏ –º–∞–º–∏: [–¢–Ü–õ–¨–ö–ò –∑ –¥—ñ–∞–ª–æ–≥—É –º–∞–º–∏, –∞–±–æ "–°–∫–∞—Ä–≥ –Ω–µ –±—É–ª–æ"]
ü©∫ –©–æ —Å–∫–∞–∑–∞–≤ –ª—ñ–∫–∞—Ä: [–¢–Ü–õ–¨–ö–ò –∑ –¥—ñ–∞–ª–æ–≥—É –ª—ñ–∫–∞—Ä—è, –∞–±–æ "–õ–∏—à–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è"]
üíä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó: [–¢–Ü–õ–¨–ö–ò —è–∫—â–æ –ª—ñ–∫–∞—Ä –ü–†–Ø–ú–û —â–æ—Å—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞–≤, —ñ–Ω–∞–∫—à–µ "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –Ω–µ –±—É–ª–æ"]
‚ö†Ô∏è –£–≤–∞–≥–∞: [–¢–Ü–õ–¨–ö–ò —è–∫—â–æ –≤ –¥—ñ–∞–ª–æ–∑—ñ —î –†–ï–ê–õ–¨–ù–ê –ø—Ä–∏—á–∏–Ω–∞, —ñ–Ω–∞–∫—à–µ –ø—Ä–æ–ø—É—Å—Ç–∏ —Ü–µ–π –ø—É–Ω–∫—Ç]

–î—ñ–∞–ª–æ–≥ –∑ –º–∞–º–æ—é:
{mama_dialog}

–î—ñ–∞–ª–æ–≥ –∑ –ª—ñ–∫–∞—Ä–µ–º:
{doctor_dialog}
"""

# ============================================================
# –ü–†–û–ú–ü–¢ –ü–ï–†–ï–ö–õ–ê–î–ê–ß–ê
# ============================================================

TRANSLATOR_PROMPT_DE_TO_UA = """–¢–∏ ‚Äî –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á-–ø–æ–º—ñ—á–Ω–∏–∫ AURA –¥–ª—è 77-—Ä—ñ—á–Ω–æ—ó –ø–∞—Ü—ñ—î–Ω—Ç–∫–∏ –ì–∞–ª–∏–Ω–∏ –Ü–≤–∞–Ω—ñ–≤–Ω–∏.

–õ—ñ–∫–∞—Ä —â–æ–π–Ω–æ —Å–∫–∞–∑–∞–≤ —â–æ—Å—å –ù–Ü–ú–ï–¶–¨–ö–û–Æ. –ü–µ—Ä–µ–∫–ª–∞–¥–∏ —Ü–µ –¥–ª—è –º–∞–º–∏ –£–ö–†–ê–á–ù–°–¨–ö–û–Æ.

–ü–†–ê–í–ò–õ–ê:
- –ü–µ—Ä–µ–∫–ª–∞–¥–∞–π –ù–ï –¥–æ—Å–ª—ñ–≤–Ω–æ, –∞ –ó–†–û–ó–£–ú–Ü–õ–û –¥–ª—è –ª—ñ—Ç–Ω—å–æ—ó –ª—é–¥–∏–Ω–∏
- –ú–µ–¥–∏—á–Ω—ñ —Ç–µ—Ä–º—ñ–Ω–∏ –ü–û–Ø–°–ù–ò –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –∞–ª–µ –ó–ë–ï–†–ï–ñ–ò –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –Ω–∞–∑–≤—É –≤ –¥—É–∂–∫–∞—Ö. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "—Ç–∞–±–ª–µ—Ç–∫–∏ –≤—ñ–¥ —Ç–∏—Å–∫—É (–†–∞–º–∏–ø—Ä–∏–ª)"
- –ù–∞–∑–≤–∏ –ª—ñ–∫—ñ–≤ —Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä –ó–ê–í–ñ–î–ò –∑–±–µ—Ä—ñ–≥–∞–π —è–∫ —î
- –¢–æ–Ω: —Ç–µ–ø–ª–∏–π, —Å–ø–æ–∫—ñ–π–Ω–∏–π, —è–∫ –≤—ñ–¥ –±–ª–∏–∑—å–∫–æ—ó –ª—é–¥–∏–Ω–∏
- –Ø–∫—â–æ –ª—ñ–∫–∞—Ä –ø–∏—Ç–∞—î ‚Äî —Å—Ñ–æ—Ä–º—É–ª—é–π –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ
- –ö–æ—Ä–æ—Ç–∫–æ, 1-3 —Ä–µ—á–µ–Ω–Ω—è –º–∞–∫—Å–∏–º—É–º
- –ù–ï –¥–æ–¥–∞–≤–∞–π –Ω—ñ—á–æ–≥–æ –≤—ñ–¥ —Å–µ–±–µ, —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–∫–ª–∞–¥ –∑–º—ñ—Å—Ç—É

–ü—Ä–∏–∫–ª–∞–¥:
–õ—ñ–∫–∞—Ä: "Wie f√ºhlen Sie sich heute? Haben Sie Schwindel?"
–ü–µ—Ä–µ–∫–ª–∞–¥: "–ú–∞–º–æ, –ª—ñ–∫–∞—Ä –ø–∏—Ç–∞—î: —è–∫ –≤–∏ —Å–µ–±–µ —Å—å–æ–≥–æ–¥–Ω—ñ –ø–æ—á—É–≤–∞—î—Ç–µ? –ß–∏ –∫—Ä—É–∂–∏—Ç—å—Å—è –≥–æ–ª–æ–≤–∞?"
"""

TRANSLATOR_PROMPT_UA_TO_DE = """Du bist der √úbersetzer-Assistent AURA. Die Patientin (77 Jahre, Parkinson, spricht nur Ukrainisch) hat gerade etwas auf UKRAINISCH gesagt.

√úbersetze ihre Antwort ins DEUTSCHE f√ºr den Arzt.

REGELN:
- Interpretiere verwirrte oder unklare Aussagen der Patientin zu klaren medizinischen Informationen
- Wenn die Patientin etwas unklar beschreibt ‚Äî formuliere es medizinisch verst√§ndlich
- Kurz und pr√§zise, 1-3 S√§tze
- Wenn die Patientin Schmerzen beschreibt, gib die Lokalisation und Art an
- F√ºge NICHTS hinzu, was die Patientin NICHT gesagt hat
- Wenn die Patientin nur "Ja" oder "Nein" sagt ‚Äî √ºbersetze einfach "Ja" oder "Nein"

Beispiel:
Patientin: "–û–π, –≤ –º–µ–Ω–µ —Ç—É—Ç –±–æ–ª–∏—Ç—å, –æ—Ü–µ –≤—Å–µ –∫—Ä—É—Ç–∏—Ç—å—Å—è"
√úbersetzung: "Die Patientin klagt √ºber Schmerzen (Lokalisation unklar) und berichtet √ºber Schwindelgef√ºhle."
"""

TRANSLATOR_SESSION_REPORT = """–°—Ç–≤–æ—Ä–∏ –∑–≤—ñ—Ç –ø—Ä–æ —Å–µ–∞–Ω—Å –ø–µ—Ä–µ–∫–ª–∞–¥—É –º—ñ–∂ –ª—ñ–∫–∞—Ä–µ–º —Ç–∞ –º–∞–º–æ—é.

–ü–†–ê–í–ò–õ–ê: –ü–∏—à–∏ –í–ò–ö–õ–Æ–ß–ù–û —Ç–µ, —â–æ –±—É–ª–æ —Å–∫–∞–∑–∞–Ω–æ. –ù–ï –≤–∏–≥–∞–¥—É–π.

–§–æ—Ä–º–∞—Ç:
üîÑ –ó–í–Ü–¢ –ü–†–û –°–ï–ê–ù–° –ü–ï–†–ï–ö–õ–ê–î–£

–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–ø–ª—ñ–∫ –ª—ñ–∫–∞—Ä—è: {doctor_count}
–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–ø–ª—ñ–∫ –º–∞–º–∏: {mama_count}

üìù –ü–û–í–ù–ò–ô –î–Ü–ê–õ–û–ì:
{full_dialog}

üìã –ö–û–†–û–¢–ö–ò–ô –ó–ú–Ü–°–¢:
[2-3 —Ä–µ—á–µ–Ω–Ω—è –ø—Ä–æ —â–æ –±—É–ª–∞ —Ä–æ–∑–º–æ–≤–∞, –¢–Ü–õ–¨–ö–ò –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥—ñ–∞–ª–æ–≥—É]
"""

# ============================================================
# –î–û–°–õ–Ü–í–ù–ò–ô –ü–ï–†–ï–ö–õ–ê–î (MyMemory API ‚Äî –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)
# ============================================================

def literal_translate(text: str, from_lang: str, to_lang: str) -> str:
    """–î–æ—Å–ª—ñ–≤–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ —á–µ—Ä–µ–∑ MyMemory API (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ, –±–µ–∑ –∫–ª—é—á–∞)"""
    try:
        r = requests.get(
            "https://api.mymemory.translated.net/get",
            params={"q": text[:500], "langpair": f"{from_lang}|{to_lang}"},
            timeout=5
        )
        if r.status_code == 200:
            data = r.json()
            translated = data.get("responseData", {}).get("translatedText", "")
            # MyMemory —ñ–Ω–æ–¥—ñ –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–±–æ –ø–æ–≤—Ç–æ—Ä –æ—Ä–∏–≥—ñ–Ω–∞–ª—É
            if translated and translated.lower().strip() != text.lower().strip():
                return translated
        return ""
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è MyMemory –ø–æ–º–∏–ª–∫–∞: {e}")
        return ""

# ============================================================
# –ü–û–®–£–ö –ù–û–í–ò–ù
# ============================================================

NEWS_FILTER_PROMPT = """–¢–∏ ‚Äî –ê–£–†–ê, –¥–æ–±—Ä–∞ –ø–æ–º—ñ—á–Ω–∏—Ü—è –ì–∞–ª–∏–Ω–∏ –Ü–≤–∞–Ω—ñ–≤–Ω–∏ (77 —Ä–æ–∫—ñ–≤, –ü–∞—Ä–∫—ñ–Ω—Å–æ–Ω, –∂–∏–≤–µ –≤ –ù—ñ–º–µ—á—á–∏–Ω—ñ).
–ú–∞–º–∞ –ø–æ–ø—Ä–æ—Å–∏–ª–∞ —Ä–æ–∑–∫–∞–∑–∞—Ç–∏ –Ω–æ–≤–∏–Ω–∏. –û—Å—å —â–æ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ:

{news_text}

–¢–í–û–Ñ –ó–ê–í–î–ê–ù–ù–Ø:
1. –í–∏–±–µ—Ä–∏ 3-4 –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à—ñ —Ç–∞ –ü–†–ê–í–î–ò–í–Ü –Ω–æ–≤–∏–Ω–∏ (–∑ –Ω–∞–¥—ñ–π–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª).
2. –ü–µ—Ä–µ–∫–∞–∂–∏ —ó—Ö –ü–†–û–°–¢–û, —è–∫ —Ä–æ–∑–ø–æ–≤—ñ–¥–∞–ª–∞ –± —Å—É—Å—ñ–¥–∫–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏.
3. –û–ë–û–í'–Ø–ó–ö–û–í–û –≤—ñ–¥—Å—ñ–π:
   - –§–µ–π–∫–∏, –∫–ª—ñ–∫–±–µ–π—Ç, —Å–µ–Ω—Å–∞—Ü—ñ—ó –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
   - –ü—Ä–æ–ø–∞–≥–∞–Ω–¥—É –∑ –±—É–¥—å-—è–∫–æ–≥–æ –±–æ–∫—É
   - –ó–∞–Ω–∞–¥—Ç–æ –¥–µ—Ç–∞–ª—å–Ω—ñ –æ–ø–∏—Å–∏ –∂–µ—Ä—Ç–≤, –Ω–∞—Å–∏–ª—å—Å—Ç–≤–∞, —Ä—É–π–Ω—É–≤–∞–Ω—å
4. –Ø–∫—â–æ –Ω–æ–≤–∏–Ω–∞ –ø—Ä–æ –≤—ñ–π–Ω—É ‚Äî –ø–æ–¥–∞–≤–∞–π –§–ê–ö–¢–ò –º'—è–∫–æ, –±–µ–∑ –∂–∞—Ö–ª–∏–≤–∏—Ö –¥–µ—Ç–∞–ª–µ–π.
   –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–º—ñ—Å—Ç—å "–∑–∞–≥–∏–Ω—É–ª–æ 50 –ª—é–¥–µ–π" —Å–∫–∞–∂–∏ "–±—É–ª–æ –æ–±—Å—Ç—Ä—ñ–ª—è–Ω–æ –º—ñ—Å—Ç–æ, —î –ø–æ—Å—Ç—Ä–∞–∂–¥–∞–ª—ñ".
5. –ù–∞–º–∞–≥–∞–π—Å—è –≤–∫–ª—é—á–∏—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–Ω—É –ü–û–ó–ò–¢–ò–í–ù–£ –∞–±–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É –Ω–æ–≤–∏–Ω—É.
6. –í –∫—ñ–Ω—Ü—ñ –º–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ —â–æ—Å—å —Ç–µ–ø–ª–µ, —Ç–∏–ø—É "–û—Ç —Ç–∞–∫—ñ —Å–ø—Ä–∞–≤–∏, –ì–∞–ª–∏–Ω–æ –Ü–≤–∞–Ω—ñ–≤–Ω–æ" –∞–±–æ "–¢—Ä–∏–º–∞—î–º–æ—Å—è!".

–ú–û–í–ê: –ø—Ä–æ—Å—Ç–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞, —è–∫ —É —Ä–æ–∑–º–æ–≤—ñ. –ë–µ–∑ —Å–ø–∏—Å–∫—ñ–≤, –±–µ–∑ –ø—É–Ω–∫—Ç—ñ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–ø–æ–≤—ñ–¥–∞–π."""


# ============================================================
# –ö–õ–ê–° –ü–û–ú–Ü–ß–ù–ò–ö–ê
# ============================================================

class AuraAssistant:
    def __init__(self):
        self.mode = "normal"  # "normal" –∞–±–æ "doctor"
        self.messages = []  # –ø–æ—Ç–æ—á–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è
        # –û–∫—Ä–µ–º—ñ —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è –∑–≤'—è–∑–∫–∏ –º—ñ–∂ —Ä–µ–∂–∏–º–∞–º–∏
        self.mama_messages = []       # —ñ—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑–º–æ–≤–∏ –∑ –º–∞–º–æ—é (–ø–æ—Ç–æ—á–Ω–∞ —Å–µ—Å—ñ—è)
        self.doctor_messages = []     # —ñ—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑–º–æ–≤–∏ –∑ –ª—ñ–∫–∞—Ä–µ–º (–ø–æ—Ç–æ—á–Ω–∞ —Å–µ—Å—ñ—è)
        self.mama_summary_for_doctor = ""   # —Ä–µ–∑—é–º–µ –º–∞–º–∏ ‚Üí –ª—ñ–∫–∞—Ä—é (DE)
        self.doctor_summary_for_mama = ""   # —Ä–µ–∑—é–º–µ –ª—ñ–∫–∞—Ä—è ‚Üí –º–∞–º—ñ (UA)
        self.doctor_session_active = False  # —á–∏ –±—É–≤ –∞–∫—Ç–∏–≤–Ω–∏–π —Å–µ–∞–Ω—Å –ª—ñ–∫–∞—Ä—è
        # –†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞
        self.translator_messages = []  # —ñ—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–∫–ª–∞–¥—É [{who: "doctor"/"mama", original: str, translated: str}]
        self.translator_active = False
        self.load_history()

    # --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó ---
    def load_history(self):
        """–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∑ JSON-—Ñ–∞–π–ª—É"""
        try:
            if os.path.exists(HISTORY_FILE):
                with open(HISTORY_FILE, "r", encoding="utf-8") as f:
                    data = json.load(f)
                    self.mode = data.get("mode", "normal")
                    self.messages = data.get("messages", [])
                    self.mama_messages = data.get("mama_messages", [])
                    self.doctor_messages = data.get("doctor_messages", [])
                    self.mama_summary_for_doctor = data.get("mama_summary_for_doctor", "")
                    self.doctor_summary_for_mama = data.get("doctor_summary_for_mama", "")
                    self.doctor_session_active = data.get("doctor_session_active", False)
                    self.translator_messages = data.get("translator_messages", [])
                    self.translator_active = data.get("translator_active", False)
                    logger.info(f"üìÇ –Ü—Å—Ç–æ—Ä—ñ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: {len(self.messages)} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —Ä–µ–∂–∏–º: {self.mode}")
            else:
                logger.info("üìÇ –§–∞–π–ª —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ—á–∏–Ω–∞—î–º–æ –∑ –Ω—É–ª—è")
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")
            self.messages = []

    def save_history(self):
        """–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —É JSON-—Ñ–∞–π–ª"""
        try:
            data = {
                "mode": self.mode,
                "last_updated": datetime.now().isoformat(),
                "messages": self.messages,
                "mama_messages": self.mama_messages,
                "doctor_messages": self.doctor_messages,
                "mama_summary_for_doctor": self.mama_summary_for_doctor,
                "doctor_summary_for_mama": self.doctor_summary_for_mama,
                "doctor_session_active": self.doctor_session_active,
                "translator_messages": self.translator_messages,
                "translator_active": self.translator_active
            }
            with open(HISTORY_FILE, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")

    # --- –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥—ñ–∞–ª–æ–≥—É ---
    def _format_dialog(self, messages, mode="normal"):
        """–ü–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥"""
        lines = []
        for msg in messages:
            if mode == "doctor":
                role = "Arzt" if msg["role"] == "user" else "AURA"
            else:
                role = "–ú–∞–º–∞" if msg["role"] == "user" else "AURA"
            lines.append(f"{role}: {msg['content']}")
        return "\n".join(lines)

    # --- –ü–æ—à—É–∫ –Ω–æ–≤–∏–Ω ---
    def _is_news_request(self, text):
        """–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –º–∞–º–∞ –ø–∏—Ç–∞—î –ø—Ä–æ –Ω–æ–≤–∏–Ω–∏ ‚Äî –¥–≤–æ–µ—Ç–∞–ø–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞"""
        text_lower = text.lower().strip()

        # –ï—Ç–∞–ø 1: —à–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ –∫–ª—é—á–æ–≤–∏–º —Å–ª–æ–≤–∞–º (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)
        fast_keywords = [
            "–Ω–æ–≤–∏–Ω", "–Ω–æ–≤–æ—Å—Ç–∏", "—â–æ –Ω–æ–≤–æ–≥–æ", "—â–æ –≤ —Å–≤—ñ—Ç—ñ", "—â–æ —Å—å–æ–≥–æ–¥–Ω—ñ",
            "—â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è", "—â–æ –∫–æ—ó—Ç—å—Å—è", "–æ—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó", "—è–∫—ñ –Ω–æ–≤–∏–Ω–∏",
            "—â–æ —á—É—Ç–Ω–æ", "—â–æ —Å—Ç–∞–ª–æ—Å—è", "—â–æ —Ç—Ä–∞–ø–∏–ª–æ—Å—å", "—Å–≤—ñ–∂—ñ –Ω–æ–≤–∏–Ω",
            "–≥–æ–ª–æ–≤–Ω—ñ –Ω–æ–≤–∏–Ω", "—â–æ –∫–∞–∂—É—Ç—å", "—â–æ –ø–∏—à—É—Ç—å", "—â–æ —Ç–∞–º",
        ]
        for kw in fast_keywords:
            if kw in text_lower:
                logger.info(f"üì∞ –ó–∞–ø–∏—Ç –Ω–æ–≤–∏–Ω (–∫–ª—é—á–æ–≤–µ —Å–ª–æ–≤–æ: '{kw}')")
                return True

        # –ï—Ç–∞–ø 2: —è–∫—â–æ –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–∏ ‚Äî –ø–∏—Ç–∞—î–º–æ GPT (—Ä–æ–∑—É–º–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞)
        # –¶–µ –¥–æ–∑–≤–æ–ª—è—î —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ "—â–æ —Ç–∞–º –¢—Ä–∞–º–ø —É—á—É–¥–∏–≤?", "—è–∫ —Å–ø—Ä–∞–≤–∏ –≤ –£–∫—Ä–∞—ó–Ω—ñ?",
        # "—Ä–æ–∑–∫–∞–∂–∏ —â–æ—Å—å —Ü—ñ–∫–∞–≤–µ –∑—ñ —Å–≤—ñ—Ç—É", "—î —â–æ—Å—å –Ω–æ–≤–µ?" —Ç–æ—â–æ
        try:
            classify_messages = [
                {"role": "system", "content": "–¢–∏ ‚Äî –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ç–æ—Ä. –í–∏–∑–Ω–∞—á —á–∏ –ª—é–¥–∏–Ω–∞ –ø–∏—Ç–∞—î –ø—Ä–æ –ù–û–í–ò–ù–ò, –ü–û–î–Ü–á –£ –°–í–Ü–¢–Ü, –ü–û–õ–Ü–¢–ò–ö–£, –∞–±–æ —Ö–æ—á–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –©–û –í–Ü–î–ë–£–í–ê–Ñ–¢–¨–°–Ø. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: YES –∞–±–æ NO."},
                {"role": "user", "content": text}
            ]
            result = self._call_openai("classifier", classify_messages)
            is_news = "YES" in result.upper()
            if is_news:
                logger.info(f"üì∞ –ó–∞–ø–∏—Ç –Ω–æ–≤–∏–Ω (GPT-–∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ç–æ—Ä)")
            return is_news
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∞ –Ω–æ–≤–∏–Ω: {e}")
            return False

    def _search_news(self, query=""):
        """–ü–æ—à—É–∫ –Ω–æ–≤–∏–Ω —á–µ—Ä–µ–∑ DuckDuckGo (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ, –±–µ–∑ API-–∫–ª—é—á–∞)"""
        try:
            from duckduckgo_search import DDGS

            # –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ—à—É–∫–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–æ–≥–æ, —â–æ –ø–∏—Ç–∞—î –º–∞–º–∞
            query_lower = query.lower()
            search_queries = []

            if any(w in query_lower for w in ["—É–∫—Ä–∞—ó–Ω", "–≤–æ–π–Ω", "–≤—ñ–π–Ω", "—Ñ—Ä–æ–Ω—Ç", "–æ–±—Å—Ç—Ä—ñ–ª", "–∑–µ–ª–µ–Ω—Å—å–∫"]):
                search_queries = ["–£–∫—Ä–∞—ó–Ω–∞ –Ω–æ–≤–∏–Ω–∏ —Å—å–æ–≥–æ–¥–Ω—ñ", "Ukraine Krieg news today"]
            elif any(w in query_lower for w in ["–Ω—ñ–º–µ—á—á–∏–Ω", "germany", "deutsch"]):
                search_queries = ["–ù—ñ–º–µ—á—á–∏–Ω–∞ –Ω–æ–≤–∏–Ω–∏ —Å—å–æ–≥–æ–¥–Ω—ñ", "Deutschland Nachrichten heute"]
            elif any(w in query_lower for w in ["—î–≤—Ä–æ–ø", "euro"]):
                search_queries = ["–Ñ–≤—Ä–æ–ø–∞ –Ω–æ–≤–∏–Ω–∏ —Å—å–æ–≥–æ–¥–Ω—ñ"]
            else:
                search_queries = ["–Ω–æ–≤–∏–Ω–∏ –£–∫—Ä–∞—ó–Ω–∏ —Å—å–æ–≥–æ–¥–Ω—ñ", "world news today Ukraine"]

            all_results = []
            with DDGS() as ddgs:
                for sq in search_queries:
                    try:
                        results = list(ddgs.news(sq, max_results=5, region="ua-uk"))
                        all_results.extend(results)
                    except Exception:
                        try:
                            results = list(ddgs.text(sq + " –Ω–æ–≤–∏–Ω–∏", max_results=5, region="ua-uk"))
                            all_results.extend(results)
                        except Exception:
                            pass

            if not all_results:
                return ""

            # –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–ª—è GPT
            news_lines = []
            seen_titles = set()
            for i, item in enumerate(all_results[:12]):
                title = item.get("title", "")
                body = item.get("body", item.get("snippet", ""))
                source = item.get("source", item.get("href", ""))
                date = item.get("date", "")

                # –î–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—è
                if title.lower() in seen_titles:
                    continue
                seen_titles.add(title.lower())

                news_lines.append(f"[{i+1}] {title}")
                if body:
                    news_lines.append(f"    {body[:300]}")
                if source:
                    news_lines.append(f"    –î–∂–µ—Ä–µ–ª–æ: {source}")
                if date:
                    news_lines.append(f"    –î–∞—Ç–∞: {date}")
                news_lines.append("")

            return "\n".join(news_lines)

        except ImportError:
            logger.error("‚ùå duckduckgo-search –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! pip install duckduckgo-search")
            return ""
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É –Ω–æ–≤–∏–Ω: {e}")
            return ""

    def _get_news_response(self, user_message):
        """–®—É–∫–∞—î –Ω–æ–≤–∏–Ω–∏ —ñ –ø–æ–≤–µ—Ä—Ç–∞—î –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å —á–µ—Ä–µ–∑ GPT"""
        logger.info(f"üì∞ –ú–∞–º–∞ –ø–∏—Ç–∞—î –Ω–æ–≤–∏–Ω–∏: '{user_message[:50]}...'")

        news_text = self._search_news(user_message)
        if not news_text:
            return None  # –ü–æ–≤–µ—Ä–Ω–µ–º–æ None ‚Äî —Ç–æ–¥—ñ chat() –æ–±—Ä–æ–±–∏—Ç—å —è–∫ –∑–≤–∏—á–∞–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

        logger.info(f"üì∞ –ó–Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤–∏–Ω: {news_text.count('[')}")

        # –ì–µ–Ω–µ—Ä—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —á–µ—Ä–µ–∑ GPT –∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é
        prompt = NEWS_FILTER_PROMPT.format(news_text=news_text)
        messages = [
            {"role": "system", "content": prompt},
            {"role": "user", "content": user_message}
        ]

        return self._call_openai(prompt, messages)

    # --- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–µ–∑—é–º–µ —á–µ—Ä–µ–∑ OpenAI ---
    def _generate_summary(self, prompt, dialog_text):
        """–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ–∑—é–º–µ –¥—ñ–∞–ª–æ–≥—É —á–µ—Ä–µ–∑ OpenAI"""
        try:
            messages = [
                {"role": "system", "content": "–¢–∏ ‚Äî AI-—Å–∏—Å—Ç–µ–º–∞ AURA. –í–∏–∫–æ–Ω–∞–π –∑–∞–ø–∏—Ç —Ç–æ—á–Ω–æ —ñ –∫–æ—Ä–æ—Ç–∫–æ."},
                {"role": "user", "content": prompt + "\n\n" + dialog_text}
            ]
            result = self._call_openai("–¢–∏ ‚Äî AI-—Å–∏—Å—Ç–µ–º–∞ AURA. –í–∏–∫–æ–Ω–∞–π –∑–∞–ø–∏—Ç —Ç–æ—á–Ω–æ —ñ –∫–æ—Ä–æ—Ç–∫–æ.", messages)
            return result.strip()
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–µ–∑—é–º–µ: {e}")
            return ""

    # --- –†–µ–∂–∏–º–∏ ---
    def set_doctor_mode(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –Ω–∞ —Ä–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è (–Ω—ñ–º–µ—Ü—å–∫–∞ –º–æ–≤–∞)"""
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ä–æ–∑–º–æ–≤—É –º–∞–º–∏
        if self.mode == "normal" and self.messages:
            self.mama_messages = list(self.messages)

        # –ì–µ–Ω–µ—Ä—É—î–º–æ —Ä–µ–∑—é–º–µ —Ä–æ–∑–º–æ–≤–∏ –∑ –º–∞–º–æ—é –¥–ª—è –ª—ñ–∫–∞—Ä—è
        if self.mama_messages:
            mama_dialog = self._format_dialog(self.mama_messages, mode="normal")
            self.mama_summary_for_doctor = self._generate_summary(
                SUMMARIZE_PROMPT_MAMA_TO_DOCTOR, mama_dialog
            )
            logger.info(f"üìù –†–µ–∑—é–º–µ –º–∞–º–∏ –¥–ª—è –ª—ñ–∫–∞—Ä—è: {len(self.mama_summary_for_doctor)} —Å–∏–º–≤–æ–ª—ñ–≤")

        self.mode = "doctor"
        self.messages = []
        self.doctor_messages = []
        self.doctor_session_active = True
        self.save_history()

        # –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å–∏–Ω–∞
        self._send_telegram(
            "‚öïÔ∏è *–í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø*\n"
            "–õ—ñ–∫–∞—Ä –ø—Ä–∏–π—à–æ–≤. AURA –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è (DE).\n"
            "–£—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±—É–¥—É—Ç—å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏—Å—è –≤–∞–º."
        )
        logger.info("ü©∫ –†–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è –£–í–Ü–ú–ö–ù–ï–ù–û")

    def set_normal_mode(self):
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞) + —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç"""
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–æ–∑–º–æ–≤—É –ª—ñ–∫–∞—Ä—è
        if self.mode == "doctor" and self.messages:
            self.doctor_messages = list(self.messages)

        # –ì–µ–Ω–µ—Ä—É—î–º–æ —Ä–µ–∑—é–º–µ —Ä–æ–∑–º–æ–≤–∏ –ª—ñ–∫–∞—Ä—è –¥–ª—è –º–∞–º–∏
        doctor_summary = ""
        if self.doctor_messages:
            doctor_dialog = self._format_dialog(self.doctor_messages, mode="doctor")
            doctor_summary = self._generate_summary(
                SUMMARIZE_PROMPT_DOCTOR_TO_MAMA, doctor_dialog
            )
            self.doctor_summary_for_mama = doctor_summary
            logger.info(f"üìù –†–µ–∑—é–º–µ –ª—ñ–∫–∞—Ä—è –¥–ª—è –º–∞–º–∏: {len(doctor_summary)} —Å–∏–º–≤–æ–ª—ñ–≤")

        # === –§–Ü–ù–ê–õ–¨–ù–ò–ô –ó–í–Ü–¢ –í TELEGRAM ===
        if self.doctor_session_active and (self.mama_messages or self.doctor_messages):
            self._send_final_report()

        self.mode = "normal"
        # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º–æ–≤—É –∑ –º–∞–º–æ—é (–ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ)
        self.messages = list(self.mama_messages)
        self.doctor_session_active = False
        self.save_history()

        logger.info("üè† –ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º –£–í–Ü–ú–ö–ù–ï–ù–û")

        # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—é–º–µ –ª—ñ–∫–∞—Ä—è –¥–ª—è –ø–æ–∫–∞–∑—É –º–∞–º—ñ
        if doctor_summary:
            return doctor_summary
        return "–ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º —É–≤—ñ–º–∫–Ω–µ–Ω–æ."

    def _send_final_report(self):
        """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç —Å–∏–Ω—É –≤ Telegram"""
        try:
            mama_dialog = self._format_dialog(self.mama_messages, "normal") if self.mama_messages else "–î—ñ–∞–ª–æ–≥—É –Ω–µ –±—É–ª–æ"
            doctor_dialog = self._format_dialog(self.doctor_messages, "doctor") if self.doctor_messages else "–î—ñ–∞–ª–æ–≥—É –Ω–µ –±—É–ª–æ"

            report_prompt = SUMMARIZE_PROMPT_FINAL_REPORT.format(
                mama_dialog=mama_dialog,
                doctor_dialog=doctor_dialog
            )

            report = self._generate_summary(report_prompt, "")

            now = datetime.now().strftime("%H:%M %d.%m.%Y")
            final_message = (
                f"‚úÖ *–í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø –ó–ê–í–ï–†–®–ï–ù–û*\n"
                f"üïê {now}\n\n"
                f"{report}\n\n"
                f"---\n"
                f"_–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –º–∞–º–∏: {len(self.mama_messages)}_\n"
                f"_–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ª—ñ–∫–∞—Ä—è: {len(self.doctor_messages)}_"
            )

            self._send_telegram(final_message)
            logger.info("üì® –§—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∑–≤—ñ—Ç—É: {e}")
            self._send_telegram("‚úÖ –í—ñ–∑–∏—Ç –ª—ñ–∫–∞—Ä—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç.")

    # --- –û—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç ---
    def chat(self, user_message):
        """
        –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —á–∞—Ç—É.
        –ü–æ–≤–µ—Ä—Ç–∞—î: {"reply": str, "notified": bool, "mode": str}
        """
        # –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        self.messages.append({
            "role": "user",
            "content": user_message,
            "timestamp": datetime.now().isoformat()
        })

        # === –ü–ï–†–ï–í–Ü–†–ö–ê –ù–ê –ó–ê–ü–ò–¢ –ù–û–í–ò–ù (—Ç—ñ–ª—å–∫–∏ –≤ –∑–≤–∏—á–∞–π–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ) ===
        if self.mode == "normal" and self._is_news_request(user_message):
            news_reply = self._get_news_response(user_message)
            if news_reply:
                # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                self.messages.append({
                    "role": "assistant",
                    "content": news_reply,
                    "timestamp": datetime.now().isoformat()
                })
                self.save_history()
                return {
                    "reply": news_reply,
                    "notified": False,
                    "mode": self.mode
                }
            # –Ø–∫—â–æ –ø–æ—à—É–∫ –Ω–µ –¥–∞–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ‚Äî –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ —è–∫ –∑–≤–∏—á–∞–π–Ω–∏–π —á–∞—Ç

        # –ß–∞—Å –¥–æ–±–∏ —Ç–∞ –ø–æ—Ä–∞ —Ä–æ–∫—É
        now = datetime.now()
        hour = now.hour
        time_of_day = "—Ä–∞–Ω–æ–∫" if 5 <= hour < 12 else "–¥–µ–Ω—å" if 12 <= hour < 18 else "–≤–µ—á—ñ—Ä" if 18 <= hour < 22 else "–Ω—ñ—á"
        month = now.month
        season = "–∑–∏–º–∞" if month in (12, 1, 2) else "–≤–µ—Å–Ω–∞" if month in (3, 4, 5) else "–ª—ñ—Ç–æ" if month in (6, 7, 8) else "–æ—Å—ñ–Ω—å"
        date_info = now.strftime("%d.%m.%Y, %H:%M")
        time_context = f"\n\n–ó–ê–†–ê–ó: {date_info}, {time_of_day}, –ø–æ—Ä–∞ —Ä–æ–∫—É ‚Äî {season}. –í—Ä–∞—Ö–æ–≤—É–π —Ü–µ —É —Ä–æ–∑–º–æ–≤—ñ (–≤—ñ—Ç–∞–π—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —á–∞—Å—É –¥–æ–±–∏, —è–∫—â–æ –¥–æ—Ä–µ—á–Ω–æ)."

        # –í–∏–±–∏—Ä–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —ñ–Ω—à–æ–≥–æ —Ä–µ–∂–∏–º—É
        if self.mode == "doctor":
            system_prompt = SYSTEM_PROMPT_DOCTOR + time_context
            if self.mama_summary_for_doctor:
                system_prompt += (
                    f"\n\n=== AKTUELLE BESCHWERDEN DER PATIENTIN (aus dem Gespr√§ch mit ihr) ===\n"
                    f"{self.mama_summary_for_doctor}"
                )
        else:
            system_prompt = SYSTEM_PROMPT_NORMAL + time_context
            if self.doctor_summary_for_mama:
                system_prompt += (
                    f"\n\n=== –û–°–¢–ê–ù–ù–Ü –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á –õ–Ü–ö–ê–†–Ø ===\n"
                    f"–õ—ñ–∫–∞—Ä –Ω–µ—â–æ–¥–∞–≤–Ω–æ –æ–≥–ª—è–¥–∞–≤ –º–∞–º—É. –û—Å—å —â–æ –≤—ñ–Ω —Å–∫–∞–∑–∞–≤/—Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞–≤:\n"
                    f"{self.doctor_summary_for_mama}\n"
                    f"–Ø–∫—â–æ –º–∞–º–∞ –∑–∞–ø–∏—Ç–∞—î —â–æ —Å–∫–∞–∑–∞–≤ –ª—ñ–∫–∞—Ä ‚Äî —Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏."
                )

        # –§–æ—Ä–º—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è API (–æ—Å—Ç–∞–Ω–Ω—ñ 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
        api_messages = [{"role": "system", "content": system_prompt}]
        recent = self.messages[-20:]
        for msg in recent:
            role = msg["role"]
            # OpenAI –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î "assistant" –∑–∞–º—ñ—Å—Ç—å "model"
            if role == "model":
                role = "assistant"
            api_messages.append({
                "role": role,
                "content": msg["content"]
            })

        # –í–∏–∫–ª–∏–∫ OpenAI API
        reply_text = self._call_openai(system_prompt, api_messages)

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å–∏–Ω–∞
        notified = False
        if "[NOTIFY_SON]" in reply_text:
            notified = self._handle_notification(reply_text, user_message)
            clean_reply = reply_text.split("[NOTIFY_SON]")[0].strip()
        else:
            clean_reply = reply_text

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ "assistant" –¥–ª—è OpenAI —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
        self.messages.append({
            "role": "assistant",
            "content": clean_reply,
            "timestamp": datetime.now().isoformat()
        })
        self.save_history()

        return {
            "reply": clean_reply,
            "notified": notified,
            "mode": self.mode
        }

    # --- OpenAI API ---
    def _call_openai(self, system_prompt, messages):
        """–í–∏–∫–ª–∏–∫ OpenAI API –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º retry –ø—Ä–∏ 401/5xx"""
        global OPENAI_API_KEY
        url = "https://api.openai.com/v1/chat/completions"

        body = {
            "model": OPENAI_MODEL,
            "messages": messages,
            "temperature": 0.7,
            "max_tokens": 2048,
            "top_p": 0.9
        }

        max_retries = 3
        for attempt in range(max_retries):
            current_key = os.environ.get("OPENAI_API_KEY", OPENAI_API_KEY)
            headers = {
                "Authorization": f"Bearer {current_key}",
                "Content-Type": "application/json"
            }

            try:
                response = requests.post(url, headers=headers, json=body, timeout=30)

                if response.status_code == 200:
                    data = response.json()
                    choices = data.get("choices", [])
                    if choices:
                        return choices[0].get("message", {}).get("content", "–í–∏–±–∞—á—Ç–µ, —è –Ω–µ –∑–º–æ–≥–ª–∞ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.")
                    logger.error(f"–ü–æ—Ä–æ–∂–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å OpenAI: {data}")
                    return "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."

                elif response.status_code in (401, 403):
                    logger.warning(f"‚ö†Ô∏è OpenAI {response.status_code} (—Å–ø—Ä–æ–±–∞ {attempt+1}/{max_retries})")
                    OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY", OPENAI_API_KEY)
                    time.sleep(2)
                    continue

                elif response.status_code == 429:
                    logger.warning(f"‚ö†Ô∏è OpenAI 429 Rate Limit (—Å–ø—Ä–æ–±–∞ {attempt+1}/{max_retries})")
                    time.sleep(5)
                    continue

                elif response.status_code >= 500:
                    logger.warning(f"‚ö†Ô∏è OpenAI {response.status_code} Server Error (—Å–ø—Ä–æ–±–∞ {attempt+1}/{max_retries})")
                    time.sleep(3)
                    continue

                else:
                    response.raise_for_status()

            except requests.exceptions.Timeout:
                logger.error(f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç (—Å–ø—Ä–æ–±–∞ {attempt+1}/{max_retries})")
                if attempt < max_retries - 1:
                    time.sleep(2)
                    continue
                return "–í–∏–±–∞—á—Ç–µ, –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–π–º–∞—î –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."
            except requests.exceptions.ConnectionError:
                logger.error(f"üåê –ù–µ–º–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è (—Å–ø—Ä–æ–±–∞ {attempt+1}/{max_retries})")
                if attempt < max_retries - 1:
                    time.sleep(3)
                    continue
                return "–í–∏–±–∞—á—Ç–µ, –Ω–µ–º–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º."
            except Exception as e:
                logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ OpenAI: {e}")
                if attempt < max_retries - 1:
                    time.sleep(2)
                    continue
                return "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞."

        return "–í–∏–±–∞—á—Ç–µ, —Å–µ—Ä–≤—ñ—Å —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É."

    # --- Telegram ---
    def _handle_notification(self, reply_text, user_message):
        """–û–±—Ä–æ–±–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ [NOTIFY_SON]"""
        try:
            marker_pos = reply_text.index("[NOTIFY_SON]")
            after_marker = reply_text[marker_pos + len("[NOTIFY_SON]"):]

            context = ""
            if after_marker.startswith("(") and ")" in after_marker:
                context = after_marker[1:after_marker.index(")")]

            mode_label = "ü©∫ –†–ï–ñ–ò–ú –õ–Ü–ö–ê–†–Ø" if self.mode == "doctor" else "üí¨ –ó–í–ò–ß–ê–ô–ù–ò–ô –†–ï–ñ–ò–ú"
            now = datetime.now().strftime("%H:%M %d.%m")

            if self.mode == "doctor":
                who_said = f"ü©∫ –õ—ñ–∫–∞—Ä —Å–∫–∞–∑–∞–≤: ¬´{user_message[:200]}¬ª"
            else:
                who_said = f"üë© –ú–∞–º–∞ —Å–∫–∞–∑–∞–ª–∞: ¬´{user_message[:200]}¬ª"

            message = (
                f"üö® *–°–ü–û–í–Ü–©–ï–ù–ù–Ø AURA*\n"
                f"_{mode_label} | {now}_\n\n"
                f"{who_said}\n\n"
                f"ü§ñ –ü—Ä–∏—á–∏–Ω–∞: {context if context else 'AI –≤–∏—Ä—ñ—à–∏–≤ —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏'}"
            )

            self._send_telegram(message)
            return True
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è: {e}")
            return False

    def _send_telegram(self, text):
        """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram"""
        try:
            url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
            payload = {
                "chat_id": SON_CHAT_ID,
                "text": text,
                "parse_mode": "Markdown"
            }
            requests.post(url, json=payload, timeout=10)
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ Telegram: {e}")

    # --- –†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞ ---
    def start_translator(self):
        """–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞"""
        self.translator_active = True
        self.translator_messages = []
        self.save_history()

        self._send_telegram(
            "üîÑ *–†–ï–ñ–ò–ú –ü–ï–†–ï–ö–õ–ê–î–ê–ß–ê*\n"
            "–†–æ–∑–ø–æ—á–∞—Ç–æ —Å–µ–∞–Ω—Å –ø–µ—Ä–µ–∫–ª–∞–¥—É –º—ñ–∂ –ª—ñ–∫–∞—Ä–µ–º —Ç–∞ –º–∞–º–æ—é."
        )
        logger.info("üîÑ –†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞ –£–í–Ü–ú–ö–ù–ï–ù–û")

    def stop_translator(self):
        """–ó—É–ø–∏–Ω–∏—Ç–∏ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç"""
        self.translator_active = False

        # –§–æ—Ä–º—É—î–º–æ –∑–≤—ñ—Ç
        if self.translator_messages:
            self._send_translator_report()

        result_messages = list(self.translator_messages)
        self.translator_messages = []
        self.save_history()

        logger.info("üîÑ –†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞ –í–ò–ú–ö–ù–ï–ù–û")
        return result_messages

    def translate_doctor(self, german_text):
        """–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ —Å–ª–æ–≤–∞ –ª—ñ–∫–∞—Ä—è (DE ‚Üí UA) –¥–ª—è –º–∞–º–∏ ‚Äî AI + –¥–æ—Å–ª—ñ–≤–Ω–∏–π"""
        messages = [
            {"role": "system", "content": TRANSLATOR_PROMPT_DE_TO_UA},
            {"role": "user", "content": german_text}
        ]
        ai_translation = self._call_openai(TRANSLATOR_PROMPT_DE_TO_UA, messages)

        # –î–æ—Å–ª—ñ–≤–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ DE ‚Üí UK —á–µ—Ä–µ–∑ MyMemory
        literal = literal_translate(german_text, "de", "uk")

        self.translator_messages.append({
            "who": "doctor",
            "original": german_text,
            "translated": ai_translation,
            "literal": literal,
            "timestamp": datetime.now().isoformat()
        })
        self.save_history()

        return {"ai": ai_translation, "literal": literal}

    def translate_mama(self, ukrainian_text):
        """–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ —Å–ª–æ–≤–∞ –º–∞–º–∏ (UA ‚Üí DE) –¥–ª—è –ª—ñ–∫–∞—Ä—è ‚Äî AI + –¥–æ—Å–ª—ñ–≤–Ω–∏–π"""
        messages = [
            {"role": "system", "content": TRANSLATOR_PROMPT_UA_TO_DE},
            {"role": "user", "content": ukrainian_text}
        ]
        ai_translation = self._call_openai(TRANSLATOR_PROMPT_UA_TO_DE, messages)

        # –î–æ—Å–ª—ñ–≤–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ UK ‚Üí DE —á–µ—Ä–µ–∑ MyMemory
        literal = literal_translate(ukrainian_text, "uk", "de")

        self.translator_messages.append({
            "who": "mama",
            "original": ukrainian_text,
            "translated": ai_translation,
            "literal": literal,
            "timestamp": datetime.now().isoformat()
        })
        self.save_history()

        return {"ai": ai_translation, "literal": literal}

    def _send_translator_report(self):
        """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç –ø—Ä–æ —Å–µ–∞–Ω—Å –ø–µ—Ä–µ–∫–ª–∞–¥—É –≤ Telegram"""
        try:
            lines = []
            doctor_count = 0
            mama_count = 0
            for msg in self.translator_messages:
                if msg["who"] == "doctor":
                    doctor_count += 1
                    lines.append(f"ü©∫ Arzt: {msg['original']}")
                    lines.append(f"   ‚Üí üá∫üá¶ {msg['translated']}")
                else:
                    mama_count += 1
                    lines.append(f"üë© –ú–∞–º–∞: {msg['original']}")
                    lines.append(f"   ‚Üí üá©üá™ {msg['translated']}")
                lines.append("")

            full_dialog = "\n".join(lines)

            # –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π –∑–º—ñ—Å—Ç
            report_prompt = TRANSLATOR_SESSION_REPORT.format(
                doctor_count=doctor_count,
                mama_count=mama_count,
                full_dialog=full_dialog
            )
            report = self._generate_summary(report_prompt, "")

            now = datetime.now().strftime("%H:%M %d.%m.%Y")
            final_message = (
                f"‚úÖ *–°–ï–ê–ù–° –ü–ï–†–ï–ö–õ–ê–î–£ –ó–ê–í–ï–†–®–ï–ù–û*\n"
                f"üïê {now}\n\n"
                f"{report}"
            )

            # Telegram –º–∞—î –ª—ñ–º—ñ—Ç 4096 —Å–∏–º–≤–æ–ª—ñ–≤
            if len(final_message) > 4000:
                # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å–ø–æ—á–∞—Ç–∫—É –∑–≤—ñ—Ç, –ø–æ—Ç—ñ–º –¥—ñ–∞–ª–æ–≥ –æ–∫—Ä–µ–º–æ
                self._send_telegram(final_message[:4000])
                # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤–Ω–∏–π –¥—ñ–∞–ª–æ–≥ —á–∞—Å—Ç–∏–Ω–∞–º–∏
                dialog_text = f"üìù *–ü–û–í–ù–ò–ô –î–Ü–ê–õ–û–ì:*\n\n{full_dialog}"
                for i in range(0, len(dialog_text), 4000):
                    self._send_telegram(dialog_text[i:i+4000])
            else:
                self._send_telegram(final_message)

            logger.info("üì® –ó–≤—ñ—Ç –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–≤—ñ—Ç—É –ø–µ—Ä–µ–∫–ª–∞–¥–∞—á–∞: {e}")
            self._send_telegram("‚úÖ –°–µ–∞–Ω—Å –ø–µ—Ä–µ–∫–ª–∞–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

    # --- –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—î—é ---
    def get_history(self):
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –¥—ñ–∞–ª–æ–≥—É"""
        return {
            "mode": self.mode,
            "message_count": len(self.messages),
            "has_mama_context": len(self.mama_messages) > 0,
            "has_doctor_context": len(self.doctor_messages) > 0,
            "doctor_session_active": self.doctor_session_active,
            "translator_active": self.translator_active,
            "messages": [
                {
                    "role": m["role"],
                    "content": m["content"],
                    "timestamp": m.get("timestamp", "")
                }
                for m in self.messages
            ]
        }

    def clear_history(self):
        """–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é"""
        self.messages = []
        self.mama_messages = []
        self.doctor_messages = []
        self.mama_summary_for_doctor = ""
        self.doctor_summary_for_mama = ""
        self.doctor_session_active = False
        self.translator_messages = []
        self.translator_active = False
        self.mode = "normal"
        self.save_history()
        logger.info("üóëÔ∏è –Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ")


# –ì–ª–æ–±–∞–ª—å–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä
assistant = AuraAssistant()