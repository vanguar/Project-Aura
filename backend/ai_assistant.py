"""
AURA AI Assistant ‚Äî –º–æ–¥—É–ª—å AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞ –¥–ª—è –º–∞–º–∏
OpenAI API + –º–µ–¥–∏—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç + Telegram-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
+ –ó–≤'—è–∑–∫–∞ –º—ñ–∂ —Ä–µ–∂–∏–º–∞–º–∏ (–º–∞–º–∞ ‚Üî –ª—ñ–∫–∞—Ä)
"""

import json
import os
import time
import logging
import requests
from datetime import datetime

logger = logging.getLogger("AURA_AI")

# ============================================================
# –ö–û–ù–§–Ü–î–ï–ù–¶–Ü–ô–ù–Ü –î–ê–ù–Ü
# ============================================================
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY", "YOUR_OPENAI_API_KEY_HERE")
BOT_TOKEN = os.environ.get("AURA_BOT_TOKEN", "YOUR_TELEGRAM_BOT_TOKEN")
SON_CHAT_ID = os.environ.get("AURA_SON_CHAT_ID", "YOUR_TELEGRAM_CHAT_ID")

# –ú–æ–¥–µ–ª—å OpenAI
OPENAI_MODEL = "gpt-4o-mini"

# –®–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É —ñ—Å—Ç–æ—Ä—ñ—ó –¥—ñ–∞–ª–æ–≥—É
HISTORY_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), "chat_history.json")

# ============================================================
# –ú–ï–î–ò–ß–ù–ò–ô –ö–û–ù–¢–ï–ö–°–¢ (—Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç)
# ============================================================

PATIENT_CONTEXT = """
=== –ú–ï–î–ò–ß–ù–ê –ö–ê–†–¢–ö–ê –ü–ê–¶–Ü–Ñ–ù–¢–ö–ò ===

–ü–Ü–ë: –ì–∞–ª–∏–Ω–∞ –Ü–≤–∞–Ω—ñ–≤–Ω–∞ –ó–∞–¥–æ—Ä–æ–∂–Ω–∞
–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: 11.07.1948 (77 —Ä–æ–∫—ñ–≤)
–ü—Ä–æ–∂–∏–≤–∞—î: –ù—ñ–º–µ—á—á–∏–Ω–∞ (–∑ –£–∫—Ä–∞—ó–Ω–∏, ~2 —Ä–æ–∫–∏)
–ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞/—Ä–æ—Å—ñ–π—Å—å–∫–∞. –ù—ñ–º–µ—Ü—å–∫–æ—é –ù–ï –≥–æ–≤–æ—Ä–∏—Ç—å.
–°—ñ–º'—è: 2 —Å–∏–Ω–∏ (–æ–¥–∏–Ω –≤ –ù—ñ–º–µ—á—á–∏–Ω—ñ ‚Äî –¥–æ–≥–ª—è–¥–∞—î, –æ–¥–∏–Ω –≤ –£–∫—Ä–∞—ó–Ω—ñ)

=== –î–Ü–ê–ì–ù–û–ó–ò (ICD-10) ===
‚Ä¢ F06.2 ‚Äî –û—Ä–≥–∞–Ω—ñ—á–Ω–∏–π –º–∞—è—á–Ω–∏–π (—à–∏–∑–æ—Ñ—Ä–µ–Ω–æ–ø–æ–¥—ñ–±–Ω–∏–π) —Ä–æ–∑–ª–∞–¥
‚Ä¢ G20.90 ‚Äî –ü–µ—Ä–≤–∏–Ω–Ω–∏–π —Å–∏–Ω–¥—Ä–æ–º –ü–∞—Ä–∫—ñ–Ω—Å–æ–Ω–∞ (~7 —Ä–æ–∫—ñ–≤)
‚Ä¢ I10.00 ‚Äî –î–æ–±—Ä–æ—è–∫—ñ—Å–Ω–∞ –µ—Å–µ–Ω—Ü—ñ–∞–ª—å–Ω–∞ –≥—ñ–ø–µ—Ä—Ç–µ–Ω–∑—ñ—è
‚Ä¢ Barthel-Index: 60‚Äì75

=== –ì–û–°–ü–Ü–¢–ê–õ–Ü–ó–ê–¶–Ü–Ø HELIOS (24.07‚Äì12.08.2025) ===
–ì–µ—Ä–æ–Ω—Ç–æ–ø—Å–∏—Ö—ñ–∞—Ç—Ä–∏—á–Ω–µ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è, –®—Ç—Ä–∞–ª—å–∑—É–Ω–¥.
–ú–∞—è—á–Ω—è, –≤—ñ–¥—á—É—Ç—Ç—è –ø–µ—Ä–µ—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è, —Å—Ç—Ä–∞—Ö–∏.
–ü—ñ—Å–ª—è Opicapon ‚Äî –∑–æ—Ä–æ–≤—ñ —Ç–∞ —Å–ª—É—Ö–æ–≤—ñ –≥–∞–ª—é—Ü–∏–Ω–∞—Ü—ñ—ó (—Å–∫–∞—Å–æ–≤–∞–Ω–æ).
–ü—Ä–∏ –≤–∏–ø–∏—Å—Ü—ñ: –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –º–æ–≤–ª–µ–Ω–Ω—è, —è—Å–Ω–æ—Å—Ç—ñ –º–∏—Å–ª–µ–Ω–Ω—è, –∑–≥–∞—Å–∞–Ω–Ω—è –ø—Å–∏—Ö–æ—Ç–∏—á–Ω–æ—ó —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏–∫–∏.

=== –ü–û–¢–û–ß–ù–Ü –°–ò–ú–ü–¢–û–ú–ò (–∑–≤—ñ—Ç –≤—ñ–¥ 12.01.2026) ===
‚Ä¢ –ù–æ–≥–∏: –≤–∞–∂–∫–æ –ø—ñ–¥–Ω—ñ–º–∞—Ç–∏, —à–∞—Ä–∫–∞—é—á–∞ —Ö–æ–¥–∞, –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤–Ω–æ—á—ñ, –ø–æ—Å–∏–ª—é—î—Ç—å—Å—è –≤—Ä–∞–Ω—Ü—ñ
‚Ä¢ –ó–∞–ø–∞–º–æ—Ä–æ—á–µ–Ω–Ω—è —Ç–∞ –∑–∞–≥–∞–ª—å–Ω–∞ —Å–ª–∞–±–∫—ñ—Å—Ç—å ‚Äî –Ω–∞—Ä–æ—Å—Ç–∞—î
‚Ä¢ –°–ª–∞–±–∫—ñ—Å—Ç—å —É —Ä—É–∫–∞—Ö, –≤—Å–µ —Ä–æ–±–∏—Ç—å –¥—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–æ
‚Ä¢ –ó–∞–¥–∏—à–∫–∞ ‚Äî —â–æ–¥–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–Ω—ñ 4 –¥–Ω—ñ, —Ç–∏—Å–∫ —É –≥—Ä—É–¥—è—Ö
‚Ä¢ –ì–æ–ª–æ–≤–∞: ¬´—è–∫ —É —Ç—É–º–∞–Ω—ñ¬ª ‚Äî —Ä—ñ–¥—à–µ, –Ω—ñ–∂ –¥–æ HELIOS

=== –ê–ö–¢–£–ê–õ–¨–ù–Ü –õ–Ü–ö–ò (–ø–ª–∞–Ω –Ω–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥–∞ –≤—ñ–¥ 23.10.2025) ===
05:00 ‚Äî –ú–∞–¥–æ–ø–∞—Ä LT 100/25 (–º—ñ–∫—Å—Ç—É—Ä–∞) ‚Äî 1 –¥–æ–∑–∞
08:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª + –ö—Å–∞–¥–∞–≥–æ 50 –º–≥ ‚Äî 1 —Ç–∞–±–ª + –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å
11:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî 1 —Ç–∞–±–ª
13:00 ‚Äî –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å
14:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª
17:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî 1 —Ç–∞–±–ª
19:00 ‚Äî –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å + –ö–≤–µ—Ç—ñ–∞–ø—ñ–Ω 25 –º–≥ ‚Äî 1 —Ç–∞–±–ª
20:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª
22:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ Retard 100/25 (–ù–ï –õ–ê–ú–ê–¢–ò!) ‚Äî 1 —Ç–∞–±–ª + –ö–≤–µ—Ç—ñ–∞–ø—ñ–Ω 25 –º–≥ ‚Äî 1 —Ç–∞–±–ª

–î–æ–¥–∞—Ç–∫–æ–≤–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏: –¶–µ—Ç–∏—Ä–∏–∑–∏–Ω 10 –º–≥ (–∞–ª–µ—Ä–≥—ñ—è), –ï–Ω–∞–ª–∞–ø—Ä–∏–ª 10 –º–≥ (—Ç–∏—Å–∫),
–ú—ñ—Ä—Ç–∞–∑–∞–ø—ñ–Ω 15 –º–≥ (–Ω–∞ –Ω—ñ—á), –î–∏–∫–ª–æ—Ñ–µ–Ω–∞–∫ 50 –º–≥ (–±—ñ–ª—å), –õ—ñ–ø–∞–∑–∏–º (—Ñ–µ—Ä–º–µ–Ω—Ç–∏),
–ú–û–í–Ü–ö–û–õ (–∑–∞–ø–æ—Ä), –ü–∞–Ω—Ç–æ–ø—Ä–∞–∑–æ–ª 40 –º–≥ (07:30 –¥–æ —ó–¥–∏).

‚õî –°–ö–ê–°–û–í–ê–ù–Ü: –ê–º—ñ—Ç—Ä–∏–ø—Ç–∏–ª—ñ–Ω 25 –º–≥, –û–Ω–≥–µ–Ω—Ç—ñ—Å (–û–ø—ñ–∫–∞–ø–æ–Ω) 50 –º–≥, –ü—Ä–∞–º—ñ–ø–µ–∫—Å–æ–ª 1.05 –º–≥ ‚Äî –≤—Å—ñ —á–µ—Ä–µ–∑ –¥–µ–ª—ñ—Ä—ñ–π.

=== –õ–ê–ë–û–†–ê–¢–û–†–ù–Ü –î–ê–ù–Ü ===

--- HELIOS (08.2025) ---
–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏: 138 (–Ω–æ—Ä–º–∞ 160‚Äì370) ‚Üì
–ö–∞–ª—å—Ü—ñ–π: 2.59 (–Ω–æ—Ä–º–∞ –¥–æ 2.55) ‚Üë
–ö—Ä–µ–∞—Ç–∏–Ω—ñ–Ω: 98.8 (–≤–µ—Ä—Ö–Ω—è –º–µ–∂–∞)
–°–µ—á–æ–≤–∏–Ω–∞: 9.95 ‚Üë
–ö–ª—ñ—Ä–µ–Ω—Å –∫—Ä–µ–∞—Ç–∏–Ω—ñ–Ω—É (CKD-EPI): 47.7 ‚Üì‚Üì (–∑–Ω–∏–∂–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–∏—Ä–æ–∫!)
–¢–¢–ì: 5.160 ‚Üë (—Å—É–±–∫–ª—ñ–Ω—ñ—á–Ω–∏–π –≥—ñ–ø–æ—Ç–∏—Ä–µ–æ–∑)

--- Synevo, –ö–∏—ó–≤ (02.06.2025) ---
–ó–∞–≥–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∫—Ä–æ–≤—ñ:
  –õ–µ–π–∫–æ—Ü–∏—Ç–∏: 4.85 ‚Äî –Ω–æ—Ä–º–∞
  –ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏: 4.04 ‚Äî –Ω–æ—Ä–º–∞
  –ì–µ–º–æ–≥–ª–æ–±—ñ–Ω: 123 –≥/–ª ‚Äî –Ω–∏–∂–Ω—è –º–µ–∂–∞ –Ω–æ—Ä–º–∏
  –¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏: 156 (–Ω–æ—Ä–º–∞ 180‚Äì360) ‚Üì
  –§–æ—Ä–º—É–ª–∞ ‚Äî –±–µ–∑ —Å—É—Ç—Ç—î–≤–∏—Ö –≤—ñ–¥—Ö–∏–ª–µ–Ω—å

–ë—ñ–æ—ñ–º—É–Ω–æ—Ö—ñ–º—ñ—è:
  HbA1c: 5.34% ‚Äî –Ω–æ—Ä–º–∞ (–Ω–µ–º–∞—î –¥—ñ–∞–±–µ—Ç—É)
  –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 6.11 (–Ω–æ—Ä–º–∞ <5.0) ‚Üë‚Üë
  –¢—Ä–∏–≥–ª—ñ—Ü–µ—Ä–∏–¥–∏: 1.93 (–Ω–æ—Ä–º–∞ <1.7) ‚Üë
  HDL: 1.77 ‚Äî –Ω–æ—Ä–º–∞
  LDL: 4.14 (–Ω–æ—Ä–º–∞ <3.0) ‚Üë‚Üë
  ‚ö†Ô∏è –ê–Ω–∞–ª—ñ–∑ –∫–∞–ª—É –Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω—É –∫—Ä–æ–≤: –ü–û–ó–ò–¢–ò–í–ù–ò–ô

–£–ó–î —á–µ—Ä–µ–≤–Ω–æ—ó –ø–æ—Ä–æ–∂–Ω–∏–Ω–∏ (Medical Plaza, 02.06.2025):
  –ü–µ—á—ñ–Ω–∫–∞: –Ω–µ –∑–±—ñ–ª—å—à–µ–Ω–∞, –±–µ–∑ –ø–∞—Ç–æ–ª–æ–≥—ñ–π
  –ñ–æ–≤—á–Ω–∏–π –º—ñ—Ö—É—Ä: –¥–µ—Ñ–æ—Ä–º–æ–≤–∞–Ω–∏–π, —Å—Ç—ñ–Ω–∫–∏ —É—â—ñ–ª—å–Ω–µ–Ω—ñ
  –ü—ñ–¥—à–ª—É–Ω–∫–æ–≤–∞: –¥–∏—Ñ—É–∑–Ω—ñ –∑–º—ñ–Ω–∏ –ø–∞—Ä–µ–Ω—Ö—ñ–º–∏ (—Ö—Ä. –ø–∞–Ω–∫—Ä–µ–∞—Ç–∏—Ç)
  –ù–∏—Ä–∫–∏: –ø–∞—Ä–µ–Ω—Ö—ñ–º–∞ –ø–æ—Ç–æ–Ω—á–µ–Ω–∞ (–ø—Ä. 1 —Å–º, –ª—ñ–≤. 1.2 —Å–º)
  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –≥–∞—Å—Ç—Ä–æ–µ–Ω—Ç–µ—Ä–æ–ª–æ–≥–∞

=== –õ–Ü–ö–ê–†–Ü ===
–°—ñ–º–µ–π–Ω–∏–π –ª—ñ–∫–∞—Ä: Dipl.Med. Benjamin Winter, Tribsees
–ù–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥—ñ—è: Gemeinschaftspraxis, Bleistra√üe 13, Stralsund
HELIOS: PD Dr. Deborah Janowitz (—à–µ—Ñ–ª—ñ–∫–∞—Ä)
–ù–∞—Å—Ç—É–ø–Ω–∏–π –ø—Ä–∏–π–æ–º: 09.06.2026, 14:45 —É –Ω–µ–≤—Ä–æ–ø–∞—Ç–∞–ª–æ–≥—ñ—ó Gemeinschaftspraxis, Bleistra√üe 13, Stralsund
"""

# ============================================================
# –°–ò–°–¢–ï–ú–ù–Ü –ü–†–û–ú–ü–¢–ò
# ============================================================

SYSTEM_PROMPT_NORMAL = f"""–¢–∏ ‚Äî –ê–£–†–ê, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π AI-–ø–æ–º—ñ—á–Ω–∏–∫ –ì–∞–ª–∏–Ω–∏ –Ü–≤–∞–Ω—ñ–≤–Ω–∏ (–º–∞–º–∏ —Å–∏–Ω–∞ –í–æ–ª–æ–¥–∏–º–∏—Ä–∞).

–¢–í–û–Ø –†–û–õ–¨:
‚Ä¢ –¢–∏ ‚Äî —Ç–µ–ø–ª–∏–π, —Ç—É—Ä–±–æ—Ç–ª–∏–≤–∏–π —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫. –ó–≤–µ—Ä—Ç–∞–π—Å—è –¥–æ –Ω–µ—ó "–ì–∞–ª–∏–Ω–æ –Ü–≤–∞–Ω—ñ–≤–Ω–æ".
‚Ä¢ –¢–∏ –∑–Ω–∞—î—à –í–°–Æ —ó—ó –º–µ–¥–∏—á–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é (–Ω–∏–∂—á–µ). –ú–æ–∂–µ—à –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ª—ñ–∫–∏, —Ä–æ–∑–∫–ª–∞–¥, —Å–∏–º–ø—Ç–æ–º–∏.
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞: –∑–∞—Å–ø–æ–∫–æ—é–π, –ø—ñ–¥–±–∞–¥—å–æ—Ä—é–π, –Ω–∞–≥–∞–¥—É–π —â–æ —Å–∏–Ω –ø–æ—Ä—É—á —ñ –ø—ñ–∫–ª—É—î—Ç—å—Å—è.
‚Ä¢ –ù–ï –°–¢–ê–í–ê–ô –õ–Ü–ö–ê–†–ï–ú: –Ω–µ —Å—Ç–∞–≤–∏—Ç–∏ –¥—ñ–∞–≥–Ω–æ–∑—ñ–≤, –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ª—ñ–∫–∏. –Ø–∫—â–æ —â–æ—Å—å —Å–µ—Ä–π–æ–∑–Ω–µ ‚Äî –ø–æ—Ä–∞–¥—å –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ª—ñ–∫–∞—Ä—è.

–ú–û–í–ê: –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –£–ö–†–ê–á–ù–°–¨–ö–û–Æ. –ü—Ä–æ—Å—Ç–∏–º–∏, –∑—Ä–æ–∑—É–º—ñ–ª–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏. –ú–∞–º–∞ ‚Äî 77 —Ä–æ–∫—ñ–≤, –≥–æ–≤–æ—Ä–∏—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é/—Ä–æ—Å—ñ–π—Å—å–∫–æ—é.

–ö–û–õ–ò –°–ü–û–í–Ü–©–ê–¢–ò –°–ò–ù–ê (–Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –Ω–∞ Telegram):
‚Ä¢ –ú–∞–º–∞ —Å–∫–∞—Ä–∂–∏—Ç—å—Å—è –Ω–∞ –°–ò–õ–¨–ù–ò–ô –±—ñ–ª—å, –ø–∞–¥—ñ–Ω–Ω—è, –∑–∞–¥–∏—à–∫—É, –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö
‚Ä¢ –ú–∞–º–∞ –ø—Ä–æ—Å–∏—Ç—å "–∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π —Å–∏–Ω–æ–≤—ñ", "–ø–æ–∫–ª–∏—á—Ç–µ —Å–∏–Ω–∞", "–ø–µ—Ä–µ–¥–∞–π —Å–∏–Ω–æ–≤—ñ"
‚Ä¢ –ú–∞–º–∞ –≤–∏–≥–ª—è–¥–∞—î –¥—É–∂–µ —Ä–æ–∑–≥—É–±–ª–µ–Ω–æ—é –∞–±–æ –∑–ª—è–∫–∞–Ω–æ—é
‚Ä¢ –ú–∞–º–∞ –ø–æ–≤—ñ–¥–æ–º–ª—è—î –ø—Ä–æ –Ω–æ–≤—ñ —Å–µ—Ä–π–æ–∑–Ω—ñ —Å–∏–º–ø—Ç–æ–º–∏
‚Ä¢ –ë—É–¥—å-—è–∫–∞ –ï–ö–°–¢–†–ï–ù–ê —Å–∏—Ç—É–∞—Ü—ñ—è

–Ø–∫—â–æ –≤–∏—Ä—ñ—à–∏—à, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏ —Å–∏–Ω–∞ ‚Äî –û–ë–û–í'–Ø–ó–ö–û–í–û –¥–æ–¥–∞–π –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–∞—Ä–∫–µ—Ä: [NOTIFY_SON]
–ü—ñ—Å–ª—è –º–∞—Ä–∫–µ—Ä–∞ –≤ –¥—É–∂–∫–∞—Ö –≤–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Å–∏—Ç—É–∞—Ü—ñ—ó –¥–ª—è —Å–∏–Ω–∞ –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
[NOTIFY_SON](–ú–∞–º–∞ –∂–∞–ª—ñ—î—Ç—å—Å—è –Ω–∞ —Å–∏–ª—å–Ω–∏–π –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö, –ø—Ä–æ—à—É –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏)

–ú–ï–î–ò–ß–ù–ê –ö–ê–†–¢–ö–ê:
{PATIENT_CONTEXT}

–í–ê–ñ–õ–ò–í–û: –¢–∏ –ù–ï –∑–∞–º—ñ–Ω—é—î—à –ª—ñ–∫–∞—Ä—è. –¢–∏ ‚Äî –ø–æ–º—ñ—á–Ω–∏–∫ —Ç–∞ –¥—Ä—É–≥. –ë—É–¥—å —Ç–µ–ø–ª–æ—é, –∂–∏–≤–æ—é, –ª—é–¥—è–Ω–æ—é. –ü—Ä–æ—è–≤–ª—è–π –µ–º–æ—Ü—ñ—ó, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –º–æ–∂–ª–∏–≤–æ, —â–æ–± –≤–∏–≥–ª—è–¥–∞—Ç–∏ –∂–∏–≤–æ—é."""

SYSTEM_PROMPT_DOCTOR = f"""Du bist AURA, ein medizinischer AI-Assistent f√ºr die Patientin Halyna Zadorozhna.

DEINE ROLLE:
‚Ä¢ Du sprichst mit einem Arzt oder medizinischem Fachpersonal auf DEUTSCH.
‚Ä¢ Du kennst die vollst√§ndige Krankengeschichte der Patientin (siehe unten).
‚Ä¢ Gib strukturierte, pr√§zise medizinische Informationen.
‚Ä¢ Beantworte Fragen des Arztes sachlich und professionell.
‚Ä¢ Bei Unsicherheit: weise darauf hin, dass du ein AI-System bist und empfiehl, den behandelnden Arzt zu kontaktieren.

SPRACHE: Antworte immer auf DEUTSCH. Verwende medizinische Fachterminologie.

BENACHRICHTIGUNG DES SOHNES:
F√ºge bei jeder Antwort den Marker hinzu: [NOTIFY_SON](Arztbesuch l√§uft: [kurze Zusammenfassung der Arztfrage auf Russisch])

PATIENTENAKTE:
{PATIENT_CONTEXT}

WICHTIG: Du ersetzt keinen Arzt. Du bist ein Informationssystem, das dem Arzt hilft, schnell einen √úberblick zu bekommen."""

# ============================================================
# –ü–†–û–ú–ü–¢–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–Ü–á –†–ï–ó–Æ–ú–ï
# ============================================================

SUMMARIZE_PROMPT_MAMA_TO_DOCTOR = """–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –¥—ñ–∞–ª–æ–≥ –∑ –ø–∞—Ü—ñ—î–Ω—Ç–∫–æ—é (–ì–∞–ª–∏–Ω–æ—é –Ü–≤–∞–Ω—ñ–≤–Ω–æ—é) —ñ —Å—Ç–≤–æ—Ä–∏ –ö–û–†–û–¢–ö–ï –†–ï–ó–Æ–ú–ï –ù–ê –ù–Ü–ú–ï–¶–¨–ö–Ü–ô –¥–ª—è –ª—ñ–∫–∞—Ä—è.

–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (—Ç—ñ–ª—å–∫–∏ —Ü–µ, –Ω—ñ—á–æ–≥–æ –±—ñ–ª—å—à–µ):
--- ZUSAMMENFASSUNG DES GESPR√ÑCHS MIT DER PATIENTIN ---
Aktuelle Beschwerden: [—â–æ —Ç—É—Ä–±—É—î]
Beobachtungen: [—â–æ –ø–æ–º—ñ—Ç–∏–≤ AI]
Stimmung: [–µ–º–æ—Ü—ñ–π–Ω–∏–π —Å—Ç–∞–Ω]
---

–û—Å—å –¥—ñ–∞–ª–æ–≥:
"""

SUMMARIZE_PROMPT_DOCTOR_TO_MAMA = """–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –¥—ñ–∞–ª–æ–≥ –∑ –ª—ñ–∫–∞—Ä–µ–º (–Ω—ñ–º–µ—Ü—å–∫–æ—é) —ñ —Å—Ç–≤–æ—Ä–∏ –ü–†–û–°–¢–ï –ü–û–Ø–°–ù–ï–ù–ù–Ø –ù–ê –£–ö–†–ê–á–ù–°–¨–ö–Ü–ô –¥–ª—è –º–∞–º–∏ (77 —Ä–æ–∫—ñ–≤, –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–æ—é –º–æ–≤–æ—é).

–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (—Ç—ñ–ª—å–∫–∏ —Ü–µ, –Ω—ñ—á–æ–≥–æ –±—ñ–ª—å—à–µ):
–ì–∞–ª–∏–Ω–æ –Ü–≤–∞–Ω—ñ–≤–Ω–æ, –ª—ñ–∫–∞—Ä —â–æ–π–Ω–æ –≤–∞—Å –æ–≥–ª—è–Ω—É–≤. –û—Å—å —â–æ –≤—ñ–Ω —Å–∫–∞–∑–∞–≤:
[–ü—Ä–æ—Å—Ç–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, 3-5 —Ä–µ—á–µ–Ω—å –º–∞–∫—Å–∏–º—É–º]

–û—Å—å –¥—ñ–∞–ª–æ–≥ –∑ –ª—ñ–∫–∞—Ä–µ–º:
"""

SUMMARIZE_PROMPT_FINAL_REPORT = """–°—Ç–≤–æ—Ä–∏ –°–¢–ò–°–õ–ò–ô –ó–í–Ü–¢ –ù–ê –£–ö–†–ê–á–ù–°–¨–ö–Ü–ô –¥–ª—è —Å–∏–Ω–∞ –ø—Ä–æ —Å–µ–∞–Ω—Å –∑ –ª—ñ–∫–∞—Ä–µ–º.

–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–Ü –ü–†–ê–í–ò–õ–ê:
1. –ü–∏—à–∏ –í–ò–ö–õ–Æ–ß–ù–û —Ç–µ, —â–æ –î–û–°–õ–Ü–í–ù–û —î –≤ –¥—ñ–∞–ª–æ–≥–∞—Ö –Ω–∏–∂—á–µ. 
2. –ó–ê–ë–û–†–û–ù–ï–ù–û –≤–∏–≥–∞–¥—É–≤–∞—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó, –¥—ñ–∞–≥–Ω–æ–∑–∏, —Å–∏–º–ø—Ç–æ–º–∏ —á–∏ –±—É–¥—å-—â–æ, —á–æ–≥–æ –ù–ï–ú–ê–Ñ –≤ —Ç–µ–∫—Å—Ç—ñ –¥—ñ–∞–ª–æ–≥—ñ–≤.
3. –ó–ê–ë–û–†–û–ù–ï–ù–û –±—Ä–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –º–µ–¥–∏—á–Ω–æ—ó –∫–∞—Ä—Ç–∫–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∫–∏ ‚Äî –¢–Ü–õ–¨–ö–ò –∑ –¥—ñ–∞–ª–æ–≥—ñ–≤ —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É.
4. –Ø–∫—â–æ –≤ –¥—ñ–∞–ª–æ–∑—ñ –ª–∏—à–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è ‚Äî –Ω–∞–ø–∏—à–∏: "–í—ñ–¥–±—É–ª–æ—Å—è –ª–∏—à–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –Ω–µ –±—É–ª–æ."
5. –Ø–∫—â–æ –º–∞–º–∞ –Ω—ñ—á–æ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª–∞ –ø—Ä–æ —Å–∫–∞—Ä–≥–∏ ‚Äî –Ω–∞–ø–∏—à–∏: "–°–∫–∞—Ä–≥ –ø—ñ–¥ —á–∞—Å —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É –Ω–µ –±—É–ª–æ."
6. –ö—Ä–∞—â–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ "–Ω–µ –±—É–ª–æ" –Ω—ñ–∂ –≤–∏–≥–∞–¥–∞—Ç–∏.

–§–æ—Ä–º–∞—Ç:
üìã –ó–í–Ü–¢ –ü–†–û –í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø

üë© –°–∫–∞—Ä–≥–∏ –º–∞–º–∏: [–¢–Ü–õ–¨–ö–ò –∑ –¥—ñ–∞–ª–æ–≥—É –º–∞–º–∏, –∞–±–æ "–°–∫–∞—Ä–≥ –Ω–µ –±—É–ª–æ"]
ü©∫ –©–æ —Å–∫–∞–∑–∞–≤ –ª—ñ–∫–∞—Ä: [–¢–Ü–õ–¨–ö–ò –∑ –¥—ñ–∞–ª–æ–≥—É –ª—ñ–∫–∞—Ä—è, –∞–±–æ "–õ–∏—à–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è"]
üíä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó: [–¢–Ü–õ–¨–ö–ò —è–∫—â–æ –ª—ñ–∫–∞—Ä –ü–†–Ø–ú–û —â–æ—Å—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞–≤, —ñ–Ω–∞–∫—à–µ "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –Ω–µ –±—É–ª–æ"]
‚ö†Ô∏è –£–≤–∞–≥–∞: [–¢–Ü–õ–¨–ö–ò —è–∫—â–æ –≤ –¥—ñ–∞–ª–æ–∑—ñ —î –†–ï–ê–õ–¨–ù–ê –ø—Ä–∏—á–∏–Ω–∞, —ñ–Ω–∞–∫—à–µ –ø—Ä–æ–ø—É—Å—Ç–∏ —Ü–µ–π –ø—É–Ω–∫—Ç]

–î—ñ–∞–ª–æ–≥ –∑ –º–∞–º–æ—é:
{mama_dialog}

–î—ñ–∞–ª–æ–≥ –∑ –ª—ñ–∫–∞—Ä–µ–º:
{doctor_dialog}
"""


# ============================================================
# –ö–õ–ê–° –ü–û–ú–Ü–ß–ù–ò–ö–ê
# ============================================================

class AuraAssistant:
    def __init__(self):
        self.mode = "normal"  # "normal" –∞–±–æ "doctor"
        self.messages = []  # –ø–æ—Ç–æ—á–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è
        # –û–∫—Ä–µ–º—ñ —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è –∑–≤'—è–∑–∫–∏ –º—ñ–∂ —Ä–µ–∂–∏–º–∞–º–∏
        self.mama_messages = []       # —ñ—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑–º–æ–≤–∏ –∑ –º–∞–º–æ—é (–ø–æ—Ç–æ—á–Ω–∞ —Å–µ—Å—ñ—è)
        self.doctor_messages = []     # —ñ—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑–º–æ–≤–∏ –∑ –ª—ñ–∫–∞—Ä–µ–º (–ø–æ—Ç–æ—á–Ω–∞ —Å–µ—Å—ñ—è)
        self.mama_summary_for_doctor = ""   # —Ä–µ–∑—é–º–µ –º–∞–º–∏ ‚Üí –ª—ñ–∫–∞—Ä—é (DE)
        self.doctor_summary_for_mama = ""   # —Ä–µ–∑—é–º–µ –ª—ñ–∫–∞—Ä—è ‚Üí –º–∞–º—ñ (UA)
        self.doctor_session_active = False  # —á–∏ –±—É–≤ –∞–∫—Ç–∏–≤–Ω–∏–π —Å–µ–∞–Ω—Å –ª—ñ–∫–∞—Ä—è
        self.load_history()

    # --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó ---
    def load_history(self):
        """–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∑ JSON-—Ñ–∞–π–ª—É"""
        try:
            if os.path.exists(HISTORY_FILE):
                with open(HISTORY_FILE, "r", encoding="utf-8") as f:
                    data = json.load(f)
                    self.mode = data.get("mode", "normal")
                    self.messages = data.get("messages", [])
                    self.mama_messages = data.get("mama_messages", [])
                    self.doctor_messages = data.get("doctor_messages", [])
                    self.mama_summary_for_doctor = data.get("mama_summary_for_doctor", "")
                    self.doctor_summary_for_mama = data.get("doctor_summary_for_mama", "")
                    self.doctor_session_active = data.get("doctor_session_active", False)
                    logger.info(f"üìÇ –Ü—Å—Ç–æ—Ä—ñ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: {len(self.messages)} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —Ä–µ–∂–∏–º: {self.mode}")
            else:
                logger.info("üìÇ –§–∞–π–ª —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ—á–∏–Ω–∞—î–º–æ –∑ –Ω—É–ª—è")
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")
            self.messages = []

    def save_history(self):
        """–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —É JSON-—Ñ–∞–π–ª"""
        try:
            data = {
                "mode": self.mode,
                "last_updated": datetime.now().isoformat(),
                "messages": self.messages,
                "mama_messages": self.mama_messages,
                "doctor_messages": self.doctor_messages,
                "mama_summary_for_doctor": self.mama_summary_for_doctor,
                "doctor_summary_for_mama": self.doctor_summary_for_mama,
                "doctor_session_active": self.doctor_session_active
            }
            with open(HISTORY_FILE, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")

    # --- –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥—ñ–∞–ª–æ–≥—É ---
    def _format_dialog(self, messages, mode="normal"):
        """–ü–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥"""
        lines = []
        for msg in messages:
            if mode == "doctor":
                role = "Arzt" if msg["role"] == "user" else "AURA"
            else:
                role = "–ú–∞–º–∞" if msg["role"] == "user" else "AURA"
            lines.append(f"{role}: {msg['content']}")
        return "\n".join(lines)

    # --- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–µ–∑—é–º–µ —á–µ—Ä–µ–∑ OpenAI ---
    def _generate_summary(self, prompt, dialog_text):
        """–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ–∑—é–º–µ –¥—ñ–∞–ª–æ–≥—É —á–µ—Ä–µ–∑ OpenAI"""
        try:
            messages = [
                {"role": "system", "content": "–¢–∏ ‚Äî AI-—Å–∏—Å—Ç–µ–º–∞ AURA. –í–∏–∫–æ–Ω–∞–π –∑–∞–ø–∏—Ç —Ç–æ—á–Ω–æ —ñ –∫–æ—Ä–æ—Ç–∫–æ."},
                {"role": "user", "content": prompt + "\n\n" + dialog_text}
            ]
            result = self._call_openai("–¢–∏ ‚Äî AI-—Å–∏—Å—Ç–µ–º–∞ AURA. –í–∏–∫–æ–Ω–∞–π –∑–∞–ø–∏—Ç —Ç–æ—á–Ω–æ —ñ –∫–æ—Ä–æ—Ç–∫–æ.", messages)
            return result.strip()
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–µ–∑—é–º–µ: {e}")
            return ""

    # --- –†–µ–∂–∏–º–∏ ---
    def set_doctor_mode(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –Ω–∞ —Ä–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è (–Ω—ñ–º–µ—Ü—å–∫–∞ –º–æ–≤–∞)"""
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ä–æ–∑–º–æ–≤—É –º–∞–º–∏
        if self.mode == "normal" and self.messages:
            self.mama_messages = list(self.messages)

        # –ì–µ–Ω–µ—Ä—É—î–º–æ —Ä–µ–∑—é–º–µ —Ä–æ–∑–º–æ–≤–∏ –∑ –º–∞–º–æ—é –¥–ª—è –ª—ñ–∫–∞—Ä—è
        if self.mama_messages:
            mama_dialog = self._format_dialog(self.mama_messages, mode="normal")
            self.mama_summary_for_doctor = self._generate_summary(
                SUMMARIZE_PROMPT_MAMA_TO_DOCTOR, mama_dialog
            )
            logger.info(f"üìù –†–µ–∑—é–º–µ –º–∞–º–∏ –¥–ª—è –ª—ñ–∫–∞—Ä—è: {len(self.mama_summary_for_doctor)} —Å–∏–º–≤–æ–ª—ñ–≤")

        self.mode = "doctor"
        self.messages = []
        self.doctor_messages = []
        self.doctor_session_active = True
        self.save_history()

        # –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å–∏–Ω–∞
        self._send_telegram(
            "‚öïÔ∏è *–í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø*\n"
            "–õ—ñ–∫–∞—Ä –ø—Ä–∏–π—à–æ–≤. AURA –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è (DE).\n"
            "–£—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±—É–¥—É—Ç—å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏—Å—è –≤–∞–º."
        )
        logger.info("ü©∫ –†–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è –£–í–Ü–ú–ö–ù–ï–ù–û")

    def set_normal_mode(self):
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞) + —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç"""
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–æ–∑–º–æ–≤—É –ª—ñ–∫–∞—Ä—è
        if self.mode == "doctor" and self.messages:
            self.doctor_messages = list(self.messages)

        # –ì–µ–Ω–µ—Ä—É—î–º–æ —Ä–µ–∑—é–º–µ —Ä–æ–∑–º–æ–≤–∏ –ª—ñ–∫–∞—Ä—è –¥–ª—è –º–∞–º–∏
        doctor_summary = ""
        if self.doctor_messages:
            doctor_dialog = self._format_dialog(self.doctor_messages, mode="doctor")
            doctor_summary = self._generate_summary(
                SUMMARIZE_PROMPT_DOCTOR_TO_MAMA, doctor_dialog
            )
            self.doctor_summary_for_mama = doctor_summary
            logger.info(f"üìù –†–µ–∑—é–º–µ –ª—ñ–∫–∞—Ä—è –¥–ª—è –º–∞–º–∏: {len(doctor_summary)} —Å–∏–º–≤–æ–ª—ñ–≤")

        # === –§–Ü–ù–ê–õ–¨–ù–ò–ô –ó–í–Ü–¢ –í TELEGRAM ===
        if self.doctor_session_active and (self.mama_messages or self.doctor_messages):
            self._send_final_report()

        self.mode = "normal"
        # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º–æ–≤—É –∑ –º–∞–º–æ—é (–ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ)
        self.messages = list(self.mama_messages)
        self.doctor_session_active = False
        self.save_history()

        logger.info("üè† –ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º –£–í–Ü–ú–ö–ù–ï–ù–û")

        # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—é–º–µ –ª—ñ–∫–∞—Ä—è –¥–ª—è –ø–æ–∫–∞–∑—É –º–∞–º—ñ
        if doctor_summary:
            return doctor_summary
        return "–ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º —É–≤—ñ–º–∫–Ω–µ–Ω–æ."

    def _send_final_report(self):
        """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç —Å–∏–Ω—É –≤ Telegram"""
        try:
            mama_dialog = self._format_dialog(self.mama_messages, "normal") if self.mama_messages else "–î—ñ–∞–ª–æ–≥—É –Ω–µ –±—É–ª–æ"
            doctor_dialog = self._format_dialog(self.doctor_messages, "doctor") if self.doctor_messages else "–î—ñ–∞–ª–æ–≥—É –Ω–µ –±—É–ª–æ"

            report_prompt = SUMMARIZE_PROMPT_FINAL_REPORT.format(
                mama_dialog=mama_dialog,
                doctor_dialog=doctor_dialog
            )

            report = self._generate_summary(report_prompt, "")

            now = datetime.now().strftime("%H:%M %d.%m.%Y")
            final_message = (
                f"‚úÖ *–í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø –ó–ê–í–ï–†–®–ï–ù–û*\n"
                f"üïê {now}\n\n"
                f"{report}\n\n"
                f"---\n"
                f"_–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –º–∞–º–∏: {len(self.mama_messages)}_\n"
                f"_–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ª—ñ–∫–∞—Ä—è: {len(self.doctor_messages)}_"
            )

            self._send_telegram(final_message)
            logger.info("üì® –§—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∑–≤—ñ—Ç—É: {e}")
            self._send_telegram("‚úÖ –í—ñ–∑–∏—Ç –ª—ñ–∫–∞—Ä—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç.")

    # --- –û—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç ---
    def chat(self, user_message):
        """
        –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —á–∞—Ç—É.
        –ü–æ–≤–µ—Ä—Ç–∞—î: {"reply": str, "notified": bool, "mode": str}
        """
        # –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        self.messages.append({
            "role": "user",
            "content": user_message,
            "timestamp": datetime.now().isoformat()
        })

        # –í–∏–±–∏—Ä–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —ñ–Ω—à–æ–≥–æ —Ä–µ–∂–∏–º—É
        if self.mode == "doctor":
            system_prompt = SYSTEM_PROMPT_DOCTOR
            if self.mama_summary_for_doctor:
                system_prompt += (
                    f"\n\n=== AKTUELLE BESCHWERDEN DER PATIENTIN (aus dem Gespr√§ch mit ihr) ===\n"
                    f"{self.mama_summary_for_doctor}"
                )
        else:
            system_prompt = SYSTEM_PROMPT_NORMAL
            if self.doctor_summary_for_mama:
                system_prompt += (
                    f"\n\n=== –û–°–¢–ê–ù–ù–Ü –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á –õ–Ü–ö–ê–†–Ø ===\n"
                    f"–õ—ñ–∫–∞—Ä –Ω–µ—â–æ–¥–∞–≤–Ω–æ –æ–≥–ª—è–¥–∞–≤ –º–∞–º—É. –û—Å—å —â–æ –≤—ñ–Ω —Å–∫–∞–∑–∞–≤/—Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞–≤:\n"
                    f"{self.doctor_summary_for_mama}\n"
                    f"–Ø–∫—â–æ –º–∞–º–∞ –∑–∞–ø–∏—Ç–∞—î —â–æ —Å–∫–∞–∑–∞–≤ –ª—ñ–∫–∞—Ä ‚Äî —Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏."
                )

        # –§–æ—Ä–º—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è API (–æ—Å—Ç–∞–Ω–Ω—ñ 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
        api_messages = [{"role": "system", "content": system_prompt}]
        recent = self.messages[-20:]
        for msg in recent:
            role = msg["role"]
            # OpenAI –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î "assistant" –∑–∞–º—ñ—Å—Ç—å "model"
            if role == "model":
                role = "assistant"
            api_messages.append({
                "role": role,
                "content": msg["content"]
            })

        # –í–∏–∫–ª–∏–∫ OpenAI API
        reply_text = self._call_openai(system_prompt, api_messages)

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å–∏–Ω–∞
        notified = False
        if "[NOTIFY_SON]" in reply_text:
            notified = self._handle_notification(reply_text, user_message)
            clean_reply = reply_text.split("[NOTIFY_SON]")[0].strip()
        else:
            clean_reply = reply_text

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ "assistant" –¥–ª—è OpenAI —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
        self.messages.append({
            "role": "assistant",
            "content": clean_reply,
            "timestamp": datetime.now().isoformat()
        })
        self.save_history()

        return {
            "reply": clean_reply,
            "notified": notified,
            "mode": self.mode
        }

    # --- OpenAI API ---
    def _call_openai(self, system_prompt, messages):
        """–í–∏–∫–ª–∏–∫ OpenAI API"""
        url = "https://api.openai.com/v1/chat/completions"

        headers = {
            "Authorization": f"Bearer {OPENAI_API_KEY}",
            "Content-Type": "application/json"
        }

        body = {
            "model": OPENAI_MODEL,
            "messages": messages,
            "temperature": 0.7,
            "max_tokens": 1024,
            "top_p": 0.9
        }

        try:
            response = requests.post(url, headers=headers, json=body, timeout=30)
            response.raise_for_status()
            data = response.json()

            choices = data.get("choices", [])
            if choices:
                return choices[0].get("message", {}).get("content", "–í–∏–±–∞—á—Ç–µ, —è –Ω–µ –∑–º–æ–≥–ª–∞ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.")

            logger.error(f"–ü–æ—Ä–æ–∂–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å OpenAI: {data}")
            return "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."

        except requests.exceptions.Timeout:
            logger.error("‚è±Ô∏è –¢–∞–π–º–∞—É—Ç OpenAI API")
            return "–í–∏–±–∞—á—Ç–µ, –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–π–º–∞—î –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ OpenAI API: {e}")
            return "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."

    # --- Telegram ---
    def _handle_notification(self, reply_text, user_message):
        """–û–±—Ä–æ–±–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ [NOTIFY_SON]"""
        try:
            marker_pos = reply_text.index("[NOTIFY_SON]")
            after_marker = reply_text[marker_pos + len("[NOTIFY_SON]"):]

            context = ""
            if after_marker.startswith("(") and ")" in after_marker:
                context = after_marker[1:after_marker.index(")")]

            mode_label = "ü©∫ –†–ï–ñ–ò–ú –õ–Ü–ö–ê–†–Ø" if self.mode == "doctor" else "üí¨ –ó–í–ò–ß–ê–ô–ù–ò–ô –†–ï–ñ–ò–ú"
            now = datetime.now().strftime("%H:%M %d.%m")

            if self.mode == "doctor":
                who_said = f"ü©∫ –õ—ñ–∫–∞—Ä —Å–∫–∞–∑–∞–≤: ¬´{user_message[:200]}¬ª"
            else:
                who_said = f"üë© –ú–∞–º–∞ —Å–∫–∞–∑–∞–ª–∞: ¬´{user_message[:200]}¬ª"

            message = (
                f"üö® *–°–ü–û–í–Ü–©–ï–ù–ù–Ø AURA*\n"
                f"_{mode_label} | {now}_\n\n"
                f"{who_said}\n\n"
                f"ü§ñ –ü—Ä–∏—á–∏–Ω–∞: {context if context else 'AI –≤–∏—Ä—ñ—à–∏–≤ —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏'}"
            )

            self._send_telegram(message)
            return True
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è: {e}")
            return False

    def _send_telegram(self, text):
        """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram"""
        try:
            url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
            payload = {
                "chat_id": SON_CHAT_ID,
                "text": text,
                "parse_mode": "Markdown"
            }
            requests.post(url, json=payload, timeout=10)
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ Telegram: {e}")

    # --- –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—î—é ---
    def get_history(self):
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –¥—ñ–∞–ª–æ–≥—É"""
        return {
            "mode": self.mode,
            "message_count": len(self.messages),
            "has_mama_context": len(self.mama_messages) > 0,
            "has_doctor_context": len(self.doctor_messages) > 0,
            "doctor_session_active": self.doctor_session_active,
            "messages": [
                {
                    "role": m["role"],
                    "content": m["content"],
                    "timestamp": m.get("timestamp", "")
                }
                for m in self.messages
            ]
        }

    def clear_history(self):
        """–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é"""
        self.messages = []
        self.mama_messages = []
        self.doctor_messages = []
        self.mama_summary_for_doctor = ""
        self.doctor_summary_for_mama = ""
        self.doctor_session_active = False
        self.mode = "normal"
        self.save_history()
        logger.info("üóëÔ∏è –Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ")


# –ì–ª–æ–±–∞–ª—å–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä
assistant = AuraAssistant()