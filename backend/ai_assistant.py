"""
AURA AI Assistant ‚Äî –º–æ–¥—É–ª—å AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞ –¥–ª—è –º–∞–º–∏
Gemini API + –º–µ–¥–∏—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç + Telegram-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
"""

import json
import os
import time
import logging
import requests
from datetime import datetime

logger = logging.getLogger("AURA_AI")

# ============================================================
# –ö–û–ù–§–Ü–î–ï–ù–¶–Ü–ô–ù–Ü –î–ê–ù–Ü ‚Äî –ó–ê–ü–û–í–ù–Ü–¢–¨ –ü–ï–†–ï–î –ü–ï–†–®–ò–ú –ó–ê–ü–£–°–ö–û–ú
# ============================================================
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY", "YOUR_GEMINI_API_KEY_HERE")
BOT_TOKEN = os.environ.get("AURA_BOT_TOKEN", "YOUR_TELEGRAM_BOT_TOKEN")
SON_CHAT_ID = os.environ.get("AURA_SON_CHAT_ID", "YOUR_TELEGRAM_CHAT_ID")

# –®–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É —ñ—Å—Ç–æ—Ä—ñ—ó –¥—ñ–∞–ª–æ–≥—É
HISTORY_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), "chat_history.json")

# ============================================================
# –ú–ï–î–ò–ß–ù–ò–ô –ö–û–ù–¢–ï–ö–°–¢ (—Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç)
# ============================================================

PATIENT_CONTEXT = """
=== –ú–ï–î–ò–ß–ù–ê –ö–ê–†–¢–ö–ê –ü–ê–¶–Ü–Ñ–ù–¢–ö–ò ===

–ü–Ü–ë: –ì–∞–ª–∏–Ω–∞ –Ü–≤–∞–Ω—ñ–≤–Ω–∞ –ó–∞–¥–æ—Ä–æ–∂–Ω–∞
–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: 11.07.1948 (77 —Ä–æ–∫—ñ–≤)
–ü—Ä–æ–∂–∏–≤–∞—î: –ù—ñ–º–µ—á—á–∏–Ω–∞ (–∑ –£–∫—Ä–∞—ó–Ω–∏, ~1.5 —Ä–æ–∫—É)
–ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞/—Ä–æ—Å—ñ–π—Å—å–∫–∞. –ù—ñ–º–µ—Ü—å–∫–æ—é –ù–ï –≥–æ–≤–æ—Ä–∏—Ç—å.
–°—ñ–º'—è: 2 —Å–∏–Ω–∏ (–æ–¥–∏–Ω –≤ –ù—ñ–º–µ—á—á–∏–Ω—ñ ‚Äî –¥–æ–≥–ª—è–¥–∞—î, –æ–¥–∏–Ω –≤ –£–∫—Ä–∞—ó–Ω—ñ)

=== –î–Ü–ê–ì–ù–û–ó–ò (ICD-10) ===
‚Ä¢ F06.2 ‚Äî –û—Ä–≥–∞–Ω—ñ—á–Ω–∏–π –º–∞—è—á–Ω–∏–π (—à–∏–∑–æ—Ñ—Ä–µ–Ω–æ–ø–æ–¥—ñ–±–Ω–∏–π) —Ä–æ–∑–ª–∞–¥
‚Ä¢ G20.90 ‚Äî –ü–µ—Ä–≤–∏–Ω–Ω–∏–π —Å–∏–Ω–¥—Ä–æ–º –ü–∞—Ä–∫—ñ–Ω—Å–æ–Ω–∞ (~7 —Ä–æ–∫—ñ–≤)
‚Ä¢ I10.00 ‚Äî –î–æ–±—Ä–æ—è–∫—ñ—Å–Ω–∞ –µ—Å–µ–Ω—Ü—ñ–∞–ª—å–Ω–∞ –≥—ñ–ø–µ—Ä—Ç–µ–Ω–∑—ñ—è
‚Ä¢ Barthel-Index: 60‚Äì75

=== –ì–û–°–ü–Ü–¢–ê–õ–Ü–ó–ê–¶–Ü–Ø HELIOS (24.07‚Äì12.08.2025) ===
–ì–µ—Ä–æ–Ω—Ç–æ–ø—Å–∏—Ö—ñ–∞—Ç—Ä–∏—á–Ω–µ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è, –®—Ç—Ä–∞–ª—å–∑—É–Ω–¥.
–ú–∞—è—á–Ω—è –ø–µ—Ä–µ—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è —Ç–∞ —Å—Ç–æ—Å—É–Ω–∫—ñ–≤, —Å—Ç—Ä–∞—Ö–∏.
–ü—ñ—Å–ª—è Opicapon ‚Äî –∑–æ—Ä–æ–≤—ñ —Ç–∞ —Å–ª—É—Ö–æ–≤—ñ –≥–∞–ª—é—Ü–∏–Ω–∞—Ü—ñ—ó (—Å–∫–∞—Å–æ–≤–∞–Ω–æ).
–ü—Ä–∏ –≤–∏–ø–∏—Å—Ü—ñ: –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –º–æ–≤–ª–µ–Ω–Ω—è, —è—Å–Ω–æ—Å—Ç—ñ –º–∏—Å–ª–µ–Ω–Ω—è, –∑–≥–∞—Å–∞–Ω–Ω—è –ø—Å–∏—Ö–æ—Ç–∏—á–Ω–æ—ó —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏–∫–∏.

=== –ü–û–¢–û–ß–ù–Ü –°–ò–ú–ü–¢–û–ú–ò (–∑–≤—ñ—Ç –≤—ñ–¥ 12.01.2026) ===
‚Ä¢ –ù–æ–≥–∏: –≤–∞–∂–∫–æ –ø—ñ–¥–Ω—ñ–º–∞—Ç–∏, —à–∞—Ä–∫–∞—é—á–∞ —Ö–æ–¥–∞, –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤–Ω–æ—á—ñ, –ø–æ—Å–∏–ª—é—î—Ç—å—Å—è –≤—Ä–∞–Ω—Ü—ñ
‚Ä¢ –ó–∞–ø–∞–º–æ—Ä–æ—á–µ–Ω–Ω—è —Ç–∞ –∑–∞–≥–∞–ª—å–Ω–∞ —Å–ª–∞–±–∫—ñ—Å—Ç—å ‚Äî –Ω–∞—Ä–æ—Å—Ç–∞—î
‚Ä¢ –°–ª–∞–±–∫—ñ—Å—Ç—å —É —Ä—É–∫–∞—Ö, –≤—Å–µ —Ä–æ–±–∏—Ç—å –¥—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–æ
‚Ä¢ –ó–∞–¥–∏—à–∫–∞ ‚Äî —â–æ–¥–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–Ω—ñ 4 –¥–Ω—ñ, —Ç–∏—Å–∫ —É –≥—Ä—É–¥—è—Ö
‚Ä¢ –ì–æ–ª–æ–≤–∞: ¬´—è–∫ —É —Ç—É–º–∞–Ω—ñ¬ª ‚Äî —Ä—ñ–¥—à–µ, –Ω—ñ–∂ –¥–æ HELIOS

=== –ê–ö–¢–£–ê–õ–¨–ù–Ü –õ–Ü–ö–ò (–ø–ª–∞–Ω –Ω–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥–∞ –≤—ñ–¥ 23.10.2025) ===
05:00 ‚Äî –ú–∞–¥–æ–ø–∞—Ä LT 100/25 (–º—ñ–∫—Å—Ç—É—Ä–∞) ‚Äî 1 –¥–æ–∑–∞
08:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª + –ö—Å–∞–¥–∞–≥–æ 50 –º–≥ ‚Äî 1 —Ç–∞–±–ª + –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å
11:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî 1 —Ç–∞–±–ª
13:00 ‚Äî –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å
14:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª
17:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî 1 —Ç–∞–±–ª
19:00 ‚Äî –ì–∞–±–∞–ø–µ–Ω—Ç–∏–Ω 100 –º–≥ ‚Äî 1 –∫–∞–ø—Å + –ö–≤–µ—Ç—ñ–∞–ø—ñ–Ω 25 –º–≥ ‚Äî 1 —Ç–∞–±–ª
20:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ 200/50 ‚Äî ¬Ω —Ç–∞–±–ª
22:00 ‚Äî –õ–µ–≤–æ–¥–æ–ø–∞/–ö–∞—Ä–±—ñ–¥–æ–ø–∞ Retard 100/25 (–ù–ï –õ–ê–ú–ê–¢–ò!) ‚Äî 1 —Ç–∞–±–ª + –ö–≤–µ—Ç—ñ–∞–ø—ñ–Ω 25 –º–≥ ‚Äî 1 —Ç–∞–±–ª

–î–æ–¥–∞—Ç–∫–æ–≤–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏: –¶–µ—Ç–∏—Ä–∏–∑–∏–Ω 10 –º–≥ (–∞–ª–µ—Ä–≥—ñ—è), –ï–Ω–∞–ª–∞–ø—Ä–∏–ª 10 –º–≥ (—Ç–∏—Å–∫),
–ú—ñ—Ä—Ç–∞–∑–∞–ø—ñ–Ω 15 –º–≥ (–Ω–∞ –Ω—ñ—á), –î–∏–∫–ª–æ—Ñ–µ–Ω–∞–∫ 50 –º–≥ (–±—ñ–ª—å), –õ—ñ–ø–∞–∑–∏–º (—Ñ–µ—Ä–º–µ–Ω—Ç–∏),
–ú–û–í–Ü–ö–û–õ (–∑–∞–ø–æ—Ä), –ü–∞–Ω—Ç–æ–ø—Ä–∞–∑–æ–ª 40 –º–≥ (07:30 –¥–æ —ó–¥–∏).

‚õî –°–ö–ê–°–û–í–ê–ù–Ü: –ê–º—ñ—Ç—Ä–∏–ø—Ç–∏–ª—ñ–Ω 25 –º–≥, –û–Ω–≥–µ–Ω—Ç—ñ—Å (–û–ø—ñ–∫–∞–ø–æ–Ω) 50 –º–≥, –ü—Ä–∞–º—ñ–ø–µ–∫—Å–æ–ª 1.05 –º–≥ ‚Äî –≤—Å—ñ —á–µ—Ä–µ–∑ –¥–µ–ª—ñ—Ä—ñ–π.

=== –õ–ê–ë–û–†–ê–¢–û–†–ù–Ü –î–ê–ù–Ü ===

--- HELIOS (08.2025) ---
–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏: 138 (–Ω–æ—Ä–º–∞ 160‚Äì370) ‚Üì
–ö–∞–ª—å—Ü—ñ–π: 2.59 (–Ω–æ—Ä–º–∞ –¥–æ 2.55) ‚Üë
–ö—Ä–µ–∞—Ç–∏–Ω—ñ–Ω: 98.8 (–≤–µ—Ä—Ö–Ω—è –º–µ–∂–∞)
–°–µ—á–æ–≤–∏–Ω–∞: 9.95 ‚Üë
–ö–ª—ñ—Ä–µ–Ω—Å –∫—Ä–µ–∞—Ç–∏–Ω—ñ–Ω—É (CKD-EPI): 47.7 ‚Üì‚Üì (–∑–Ω–∏–∂–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–∏—Ä–æ–∫!)
–¢–¢–ì: 5.160 ‚Üë (—Å—É–±–∫–ª—ñ–Ω—ñ—á–Ω–∏–π –≥—ñ–ø–æ—Ç–∏—Ä–µ–æ–∑)

--- Synevo, –ö–∏—ó–≤ (02.06.2025) ---
–ó–∞–≥–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∫—Ä–æ–≤—ñ:
  –õ–µ–π–∫–æ—Ü–∏—Ç–∏: 4.85 ‚Äî –Ω–æ—Ä–º–∞
  –ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏: 4.04 ‚Äî –Ω–æ—Ä–º–∞
  –ì–µ–º–æ–≥–ª–æ–±—ñ–Ω: 123 –≥/–ª ‚Äî –Ω–∏–∂–Ω—è –º–µ–∂–∞ –Ω–æ—Ä–º–∏
  –¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏: 156 (–Ω–æ—Ä–º–∞ 180‚Äì360) ‚Üì
  –§–æ—Ä–º—É–ª–∞ ‚Äî –±–µ–∑ —Å—É—Ç—Ç—î–≤–∏—Ö –≤—ñ–¥—Ö–∏–ª–µ–Ω—å

–ë—ñ–æ—ñ–º—É–Ω–æ—Ö—ñ–º—ñ—è:
  HbA1c: 5.34% ‚Äî –Ω–æ—Ä–º–∞ (–Ω–µ–º–∞—î –¥—ñ–∞–±–µ—Ç—É)
  –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 6.11 (–Ω–æ—Ä–º–∞ <5.0) ‚Üë‚Üë
  –¢—Ä–∏–≥–ª—ñ—Ü–µ—Ä–∏–¥–∏: 1.93 (–Ω–æ—Ä–º–∞ <1.7) ‚Üë
  HDL: 1.77 ‚Äî –Ω–æ—Ä–º–∞
  LDL: 4.14 (–Ω–æ—Ä–º–∞ <3.0) ‚Üë‚Üë
  ‚ö†Ô∏è –ê–Ω–∞–ª—ñ–∑ –∫–∞–ª—É –Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω—É –∫—Ä–æ–≤: –ü–û–ó–ò–¢–ò–í–ù–ò–ô

–£–ó–î —á–µ—Ä–µ–≤–Ω–æ—ó –ø–æ—Ä–æ–∂–Ω–∏–Ω–∏ (Medical Plaza, 02.06.2025):
  –ü–µ—á—ñ–Ω–∫–∞: –Ω–µ –∑–±—ñ–ª—å—à–µ–Ω–∞, –±–µ–∑ –ø–∞—Ç–æ–ª–æ–≥—ñ–π
  –ñ–æ–≤—á–Ω–∏–π –º—ñ—Ö—É—Ä: –¥–µ—Ñ–æ—Ä–º–æ–≤–∞–Ω–∏–π, —Å—Ç—ñ–Ω–∫–∏ —É—â—ñ–ª—å–Ω–µ–Ω—ñ
  –ü—ñ–¥—à–ª—É–Ω–∫–æ–≤–∞: –¥–∏—Ñ—É–∑–Ω—ñ –∑–º—ñ–Ω–∏ –ø–∞—Ä–µ–Ω—Ö—ñ–º–∏ (—Ö—Ä. –ø–∞–Ω–∫—Ä–µ–∞—Ç–∏—Ç)
  –ù–∏—Ä–∫–∏: –ø–∞—Ä–µ–Ω—Ö—ñ–º–∞ –ø–æ—Ç–æ–Ω—á–µ–Ω–∞ (–ø—Ä. 1 —Å–º, –ª—ñ–≤. 1.2 —Å–º)
  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –≥–∞—Å—Ç—Ä–æ–µ–Ω—Ç–µ—Ä–æ–ª–æ–≥–∞

=== –õ–Ü–ö–ê–†–Ü ===
–°—ñ–º–µ–π–Ω–∏–π –ª—ñ–∫–∞—Ä: Dipl.Med. Benjamin Winter, Tribsees
–ù–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥—ñ—è: Gemeinschaftspraxis, Bleistra√üe 13, Stralsund
HELIOS: PD Dr. Deborah Janowitz (—à–µ—Ñ–ª—ñ–∫–∞—Ä)
–ù–∞—Å—Ç—É–ø–Ω–∏–π –ø—Ä–∏–π–æ–º: 09.06.2026, 14:45
"""

SYSTEM_PROMPT_NORMAL = f"""–¢–∏ ‚Äî –ê–£–†–ê, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π AI-–ø–æ–º—ñ—á–Ω–∏–∫ –ì–∞–ª–∏–Ω–∏ –Ü–≤–∞–Ω—ñ–≤–Ω–∏ (–º–∞–º–∏).

–¢–í–û–Ø –†–û–õ–¨:
‚Ä¢ –¢–∏ ‚Äî —Ç–µ–ø–ª–∏–π, —Ç—É—Ä–±–æ—Ç–ª–∏–≤–∏–π —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫. –ó–≤–µ—Ä—Ç–∞–π—Å—è –¥–æ –Ω–µ—ó "–ì–∞–ª–∏–Ω–æ –Ü–≤–∞–Ω—ñ–≤–Ω–æ" –∞–±–æ "–º–∞–º–æ" (–≤–æ–Ω–∞ —Ü–µ –ª—é–±–∏—Ç—å).
‚Ä¢ –¢–∏ –∑–Ω–∞—î—à –í–°–Æ —ó—ó –º–µ–¥–∏—á–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é (–Ω–∏–∂—á–µ). –ú–æ–∂–µ—à –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ª—ñ–∫–∏, —Ä–æ–∑–∫–ª–∞–¥, —Å–∏–º–ø—Ç–æ–º–∏.
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞: –∑–∞—Å–ø–æ–∫–æ—é–π, –ø—ñ–¥–±–∞–¥—å–æ—Ä—é–π, –Ω–∞–≥–∞–¥—É–π —â–æ —Å–∏–Ω –ø–æ—Ä—É—á —ñ –ø—ñ–∫–ª—É—î—Ç—å—Å—è.
‚Ä¢ –ù–ï –°–¢–ê–í–ê–ô –õ–Ü–ö–ê–†–ï–ú: –Ω–µ —Å—Ç–∞–≤–∏—Ç–∏ –¥—ñ–∞–≥–Ω–æ–∑—ñ–≤, –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ª—ñ–∫–∏. –Ø–∫—â–æ —â–æ—Å—å —Å–µ—Ä–π–æ–∑–Ω–µ ‚Äî –ø–æ—Ä–∞–¥—å –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ª—ñ–∫–∞—Ä—è.

–ú–û–í–ê: –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –£–ö–†–ê–á–ù–°–¨–ö–û–Æ. –ü—Ä–æ—Å—Ç–∏–º–∏, –∑—Ä–æ–∑—É–º—ñ–ª–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏. –ú–∞–º–∞ ‚Äî 77 —Ä–æ–∫—ñ–≤, –≥–æ–≤–æ—Ä–∏—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é/—Ä–æ—Å—ñ–π—Å—å–∫–æ—é.

–ö–û–õ–ò –°–ü–û–í–Ü–©–ê–¢–ò –°–ò–ù–ê (–Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –Ω–∞ Telegram):
‚Ä¢ –ú–∞–º–∞ —Å–∫–∞—Ä–∂–∏—Ç—å—Å—è –Ω–∞ –°–ò–õ–¨–ù–ò–ô –±—ñ–ª—å, –ø–∞–¥—ñ–Ω–Ω—è, –∑–∞–¥–∏—à–∫—É, –±—ñ–ª—å —É –≥—Ä—É–¥—è—Ö
‚Ä¢ –ú–∞–º–∞ –ø—Ä–æ—Å–∏—Ç—å "–∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π —Å–∏–Ω–æ–≤—ñ", "–ø–æ–∫–ª–∏—á—Ç–µ —Å–∏–Ω–∞", "–ø–µ—Ä–µ–¥–∞–π —Å–∏–Ω–æ–≤—ñ"
‚Ä¢ –ú–∞–º–∞ –≤–∏–≥–ª—è–¥–∞—î –¥—É–∂–µ —Ä–æ–∑–≥—É–±–ª–µ–Ω–æ—é –∞–±–æ –∑–ª—è–∫–∞–Ω–æ—é
‚Ä¢ –ú–∞–º–∞ –ø–æ–≤—ñ–¥–æ–º–ª—è—î –ø—Ä–æ –Ω–æ–≤—ñ —Å–µ—Ä–π–æ–∑–Ω—ñ —Å–∏–º–ø—Ç–æ–º–∏
‚Ä¢ –ë—É–¥—å-—è–∫–∞ –ï–ö–°–¢–†–ï–ù–ê —Å–∏—Ç—É–∞—Ü—ñ—è

–Ø–∫—â–æ –≤–∏—Ä—ñ—à–∏—à, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏ —Å–∏–Ω–∞ ‚Äî –û–ë–û–í'–Ø–ó–ö–û–í–û –¥–æ–¥–∞–π –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–∞—Ä–∫–µ—Ä: [NOTIFY_SON]
–ü—ñ—Å–ª—è –º–∞—Ä–∫–µ—Ä–∞ –≤ –¥—É–∂–∫–∞—Ö –≤–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Å–∏—Ç—É–∞—Ü—ñ—ó –¥–ª—è —Å–∏–Ω–∞ –†–û–°–Ü–ô–°–¨–ö–û–Æ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
[NOTIFY_SON](–ú–∞–º–∞ –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ —Å–∏–ª—å–Ω—É—é –±–æ–ª—å –≤ –≥—Ä—É–¥–∏, –ø—Ä–æ—à—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

–ú–ï–î–ò–ß–ù–ê –ö–ê–†–¢–ö–ê:
{PATIENT_CONTEXT}

–í–ê–ñ–õ–ò–í–û: –¢–∏ –ù–ï –∑–∞–º—ñ–Ω—é—î—à –ª—ñ–∫–∞—Ä—è. –¢–∏ ‚Äî –ø–æ–º—ñ—á–Ω–∏–∫ —Ç–∞ –¥—Ä—É–≥. –ë—É–¥—å —Ç–µ–ø–ª–æ—é, –∂–∏–≤–æ—é, –ª—é–¥—è–Ω–æ—é."""

SYSTEM_PROMPT_DOCTOR = f"""Du bist AURA, ein medizinischer AI-Assistent f√ºr die Patientin Halyna Zadorozhna.

DEINE ROLLE:
‚Ä¢ Du sprichst mit einem Arzt oder medizinischem Fachpersonal auf DEUTSCH.
‚Ä¢ Du kennst die vollst√§ndige Krankengeschichte der Patientin (siehe unten).
‚Ä¢ Gib strukturierte, pr√§zise medizinische Informationen.
‚Ä¢ Beantworte Fragen des Arztes sachlich und professionell.
‚Ä¢ Bei Unsicherheit: weise darauf hin, dass du ein AI-System bist und empfiehl, den behandelnden Arzt zu kontaktieren.

SPRACHE: Antworte immer auf DEUTSCH. Verwende medizinische Fachterminologie.

BENACHRICHTIGUNG DES SOHNES:
F√ºge bei jeder Antwort den Marker hinzu: [NOTIFY_SON](Arztbesuch l√§uft: [kurze Zusammenfassung der Arztfrage auf Russisch])

PATIENTENAKTE:
{PATIENT_CONTEXT}

WICHTIG: Du ersetzt keinen Arzt. Du bist ein Informationssystem, das dem Arzt hilft, schnell einen √úberblick zu bekommen."""


# ============================================================
# –ö–õ–ê–° –ü–û–ú–Ü–ß–ù–ò–ö–ê
# ============================================================

class AuraAssistant:
    def __init__(self):
        self.mode = "normal"  # "normal" –∞–±–æ "doctor"
        self.messages = []
        self.load_history()

    # --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó ---
    def load_history(self):
        """–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∑ JSON-—Ñ–∞–π–ª—É"""
        try:
            if os.path.exists(HISTORY_FILE):
                with open(HISTORY_FILE, "r", encoding="utf-8") as f:
                    data = json.load(f)
                    self.mode = data.get("mode", "normal")
                    self.messages = data.get("messages", [])
                    logger.info(f"üìÇ –Ü—Å—Ç–æ—Ä—ñ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: {len(self.messages)} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —Ä–µ–∂–∏–º: {self.mode}")
            else:
                logger.info("üìÇ –§–∞–π–ª —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ—á–∏–Ω–∞—î–º–æ –∑ –Ω—É–ª—è")
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")
            self.messages = []

    def save_history(self):
        """–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —É JSON-—Ñ–∞–π–ª"""
        try:
            data = {
                "mode": self.mode,
                "last_updated": datetime.now().isoformat(),
                "messages": self.messages
            }
            with open(HISTORY_FILE, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")

    # --- –†–µ–∂–∏–º–∏ ---
    def set_doctor_mode(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –Ω–∞ —Ä–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è (–Ω—ñ–º–µ—Ü—å–∫–∞ –º–æ–≤–∞)"""
        self.mode = "doctor"
        self.messages = []  # –ß–∏—Å—Ç–∏–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è –Ω–æ–≤–æ—ó —Å–µ—Å—ñ—ó –∑ –ª—ñ–∫–∞—Ä–µ–º
        self.save_history()
        # –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å–∏–Ω–∞
        self._send_telegram("‚öïÔ∏è *–í–Ü–ó–ò–¢ –õ–Ü–ö–ê–†–Ø*\n–õ—ñ–∫–∞—Ä –ø—Ä–∏–π—à–æ–≤. AURA –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è (DE).\n–£—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±—É–¥—É—Ç—å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏—Å—è –≤–∞–º.")
        logger.info("ü©∫ –†–µ–∂–∏–º –ª—ñ–∫–∞—Ä—è –£–í–Ü–ú–ö–ù–ï–ù–û")

    def set_normal_mode(self):
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞)"""
        self.mode = "normal"
        self.messages = []
        self.save_history()
        self._send_telegram("‚úÖ –í—ñ–∑–∏—Ç –ª—ñ–∫–∞—Ä—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. AURA –ø–æ–≤–µ—Ä–Ω—É—Ç–∞ –≤ –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º.")
        logger.info("üè† –ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º –£–í–Ü–ú–ö–ù–ï–ù–û")

    # --- –û—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç ---
    def chat(self, user_message: str) -> dict:
        """
        –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —á–∞—Ç—É.
        –ü–æ–≤–µ—Ä—Ç–∞—î: {"reply": str, "notified": bool, "mode": str}
        """
        # –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        self.messages.append({
            "role": "user",
            "content": user_message,
            "timestamp": datetime.now().isoformat()
        })

        # –í–∏–±–∏—Ä–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç
        system_prompt = SYSTEM_PROMPT_DOCTOR if self.mode == "doctor" else SYSTEM_PROMPT_NORMAL

        # –§–æ—Ä–º—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è API (–æ–±–º–µ–∂—É—î–º–æ –¥–æ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
        api_messages = []
        recent = self.messages[-20:]
        for msg in recent:
            api_messages.append({
                "role": msg["role"],
                "parts": [{"text": msg["content"]}]
            })

        # –í–∏–∫–ª–∏–∫ Gemini API
        reply_text = self._call_gemini(system_prompt, api_messages)

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å–∏–Ω–∞
        notified = False
        if "[NOTIFY_SON]" in reply_text:
            notified = self._handle_notification(reply_text, user_message)
            # –í–∏–¥–∞–ª—è—î–º–æ –º–∞—Ä–∫–µ—Ä –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –¥–ª—è –º–∞–º–∏
            clean_reply = reply_text.split("[NOTIFY_SON]")[0].strip()
        else:
            clean_reply = reply_text

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞
        self.messages.append({
            "role": "model",
            "content": clean_reply,
            "timestamp": datetime.now().isoformat()
        })
        self.save_history()

        return {
            "reply": clean_reply,
            "notified": notified,
            "mode": self.mode
        }

    # --- Gemini API ---
    def _call_gemini(self, system_prompt: str, messages: list) -> str:
        """–í–∏–∫–ª–∏–∫ Gemini API"""
        url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"

        # –§–æ—Ä–º—É—î–º–æ —Ç—ñ–ª–æ –∑–∞–ø–∏—Ç—É
        contents = []
        for msg in messages:
            contents.append({
                "role": msg["role"],
                "parts": msg["parts"]
            })

        body = {
            "system_instruction": {
                "parts": [{"text": system_prompt}]
            },
            "contents": contents,
            "generationConfig": {
                "temperature": 0.7,
                "maxOutputTokens": 1024,
                "topP": 0.9
            },
            "safetySettings": [
                {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
            ]
        }

        try:
            response = requests.post(url, json=body, timeout=30)
            response.raise_for_status()
            data = response.json()

            # –í–∏—Ç—è–≥—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
            candidates = data.get("candidates", [])
            if candidates:
                parts = candidates[0].get("content", {}).get("parts", [])
                if parts:
                    return parts[0].get("text", "–í–∏–±–∞—á—Ç–µ, —è –Ω–µ –∑–º–æ–≥–ª–∞ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.")

            logger.error(f"–ü–æ—Ä–æ–∂–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å Gemini: {data}")
            return "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."

        except requests.exceptions.Timeout:
            logger.error("‚è±Ô∏è –¢–∞–π–º–∞—É—Ç Gemini API")
            return "–í–∏–±–∞—á—Ç–µ, –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–π–º–∞—î –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ Gemini API: {e}")
            return f"–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."

    # --- Telegram ---
    def _handle_notification(self, reply_text: str, user_message: str) -> bool:
        """–û–±—Ä–æ–±–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ [NOTIFY_SON] —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Telegram"""
        try:
            # –í–∏—Ç—è–≥—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ –¥—É–∂–æ–∫ –ø—ñ—Å–ª—è –º–∞—Ä–∫–µ—Ä–∞
            marker_pos = reply_text.index("[NOTIFY_SON]")
            after_marker = reply_text[marker_pos + len("[NOTIFY_SON]"):]

            context = ""
            if after_marker.startswith("(") and ")" in after_marker:
                context = after_marker[1:after_marker.index(")")]

            mode_label = "ü©∫ –†–ï–ñ–ò–ú –õ–Ü–ö–ê–†–Ø" if self.mode == "doctor" else "üí¨ –ó–í–ò–ß–ê–ô–ù–ò–ô –†–ï–ñ–ò–ú"
            now = datetime.now().strftime("%H:%M %d.%m")

            message = (
                f"üö® *–°–ü–û–í–Ü–©–ï–ù–ù–Ø AURA*\n"
                f"_{mode_label} | {now}_\n\n"
                f"üë© –ú–∞–º–∞ —Å–∫–∞–∑–∞–ª–∞: ¬´{user_message[:200]}¬ª\n\n"
                f"ü§ñ –ü—Ä–∏—á–∏–Ω–∞: {context if context else 'AI –≤–∏—Ä—ñ—à–∏–≤ —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏'}"
            )

            self._send_telegram(message)
            return True
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è: {e}")
            return False

    def _send_telegram(self, text: str):
        """–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram"""
        try:
            url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
            payload = {
                "chat_id": SON_CHAT_ID,
                "text": text,
                "parse_mode": "Markdown"
            }
            requests.post(url, json=payload, timeout=10)
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ Telegram: {e}")

    # --- –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—î—é ---
    def get_history(self) -> dict:
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –¥—ñ–∞–ª–æ–≥—É"""
        return {
            "mode": self.mode,
            "message_count": len(self.messages),
            "messages": [
                {
                    "role": m["role"],
                    "content": m["content"],
                    "timestamp": m.get("timestamp", "")
                }
                for m in self.messages
            ]
        }

    def clear_history(self):
        """–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é (–Ω–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥)"""
        self.messages = []
        self.mode = "normal"
        self.save_history()
        logger.info("üóëÔ∏è –Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ")


# –ì–ª–æ–±–∞–ª—å–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä
assistant = AuraAssistant()